<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>First Shot Analysis - Basketball Scraper</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2d3748;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #48bb78;
            color: white;
        }

        .btn-secondary:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .main-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .stat-item {
            flex: 1;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th {
            background: #667eea;
            color: white;
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
        }

        .data-table td {
            padding: 6px 6px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 10px;
            white-space: nowrap;
        }

        .data-table td.player-name {
            white-space: normal;
            word-wrap: break-word;
            max-width: 100px;
            position: relative;
        }
        
        .player-tooltip {
            position: fixed;
            display: none;
            background: #2d3748;
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 9999;
            min-width: 220px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        
        .player-name.show-tooltip .player-tooltip {
            display: block;
        }
        
        .tooltip-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .tooltip-row:last-child {
            border-bottom: none;
        }
        
        .tooltip-label {
            color: #a0aec0;
        }
        
        .tooltip-value {
            font-weight: 600;
            color: #48bb78;
        }

        .data-table tbody tr.game-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .data-table tbody tr.game-row:hover {
            background-color: #edf2f7 !important;
        }

        .data-table tbody tr.game-row.expanded {
            background-color: #e6fffa !important;
        }

        .pbp-detail-row {
            display: none;
            background-color: #f7fafc;
        }

        .pbp-detail-row.show {
            display: table-row;
        }

        .pbp-detail-cell {
            padding: 0 !important;
            border: none !important;
        }

        .pbp-detail-content {
            padding: 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .pbp-detail-content.expanded {
            max-height: 1000px;
            transition: max-height 0.5s ease-in;
        }

        .pbp-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .pbp-table th {
            background: #48bb78;
            color: white;
            padding: 10px;
            text-align: left;
            font-size: 12px;
        }

        .pbp-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 11px;
        }

        .pbp-table tr:last-child td {
            border-bottom: none;
        }

        .pbp-table tr:hover {
            background-color: #f7fafc;
        }

        .pbp-loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .expand-icon {
            display: inline-block;
            margin-right: 8px;
            transition: transform 0.3s ease;
            font-size: 14px;
        }

        .game-row.expanded .expand-icon {
            transform: rotate(90deg);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        /* First shot made (took and made the very first shot) - bright green border */
        .highlight-first-shot-made {
            background-color: #48bb78 !important;
            color: white !important;
            font-weight: 600;
            border: 3px solid #22c55e !important;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.6) !important;
        }
        
        /* First shot missed (took and missed the very first shot) - bright yellow border */
        .highlight-first-shot-missed {
            background-color: #ecc94b !important;
            color: #2d3748 !important;
            font-weight: 600;
            border: 3px solid #facc15 !important;
            box-shadow: 0 0 8px rgba(250, 204, 21, 0.6) !important;
        }
        
        /* First FG made (but not the first shot) - regular green fill */
        .highlight-first-fg-made {
            background-color: #48bb78 !important;
            color: white !important;
            font-weight: 600;
        }
        
        /* Missed shot (but not the first shot) - regular yellow fill */
        .highlight-missed-shot {
            background-color: #ecc94b !important;
            color: #2d3748 !important;
            font-weight: 600;
        }
        
        /* Free throw - yellow outline only */
        .highlight-free-throw {
            border: 2px solid #ecc94b !important;
            color: #2d3748 !important;
            font-weight: 600;
        }
        
        /* Legacy classes for backwards compatibility */
        .highlight-green {
            background-color: #48bb78 !important;
            color: white !important;
            font-weight: 600;
        }

        .highlight-yellow {
            background-color: #ecc94b !important;
            color: #2d3748 !important;
            font-weight: 600;
        }

        .legend {
            margin-top: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 0.8s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with Navigation -->
        <div class="header">
            <h1>üéØ First Shot Analysis</h1>
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="refreshAnalysis()">
                    üîÑ Refresh Analysis
                </button>
                <a href="/" class="btn btn-primary">
                    ‚¨ÖÔ∏è Back to Scraper
                </a>
            </div>
        </div>

        <!-- Scoring Metrics Configuration -->
        <div class="main-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 20px;">
            <h2 style="margin: 0 0 15px 0; color: white;">‚öôÔ∏è Scoring Metrics Configuration</h2>
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; font-size: 11px; margin-bottom: 5px; opacity: 0.9;">Takes First Shot & Makes It</label>
                    <input type="number" id="score_first_shot_made" value="1.0" step="0.25" min="0" max="10"
                           onchange="recalculateScores()"
                           style="width: 100%; padding: 8px; border-radius: 4px; border: none; font-size: 14px; font-weight: 600;">
                </div>
                <div>
                    <label style="display: block; font-size: 11px; margin-bottom: 5px; opacity: 0.9;">Takes First Shot & Misses It</label>
                    <input type="number" id="score_first_shot_missed" value="0.75" step="0.25" min="0" max="10"
                           onchange="recalculateScores()"
                           style="width: 100%; padding: 8px; border-radius: 4px; border: none; font-size: 14px; font-weight: 600;">
                </div>
                <div>
                    <label style="display: block; font-size: 11px; margin-bottom: 5px; opacity: 0.9;">Made First FG (but wasn't first shot)</label>
                    <input type="number" id="score_first_fg_made" value="0.5" step="0.25" min="0" max="10"
                           onchange="recalculateScores()"
                           style="width: 100%; padding: 8px; border-radius: 4px; border: none; font-size: 14px; font-weight: 600;">
                </div>
                <div>
                    <label style="display: block; font-size: 11px; margin-bottom: 5px; opacity: 0.9;">Missed a Shot Before First FG</label>
                    <input type="number" id="score_missed_shot" value="0.25" step="0.25" min="0" max="10"
                           onchange="recalculateScores()"
                           style="width: 100%; padding: 8px; border-radius: 4px; border: none; font-size: 14px; font-weight: 600;">
                </div>
                <div>
                    <label style="display: block; font-size: 11px; margin-bottom: 5px; opacity: 0.9;">Took Free Throws Before First FG</label>
                    <input type="number" id="score_free_throw" value="1.0" step="0.25" min="0" max="10"
                           onchange="recalculateScores()"
                           style="width: 100%; padding: 8px; border-radius: 4px; border: none; font-size: 14px; font-weight: 600;">
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; font-size: 11px; margin-bottom: 5px; opacity: 0.9;">Top Players Threshold (Min Avg Score)</label>
                    <input type="number" id="top_players_threshold" value="0.25" step="0.05" min="0" max="5"
                           onchange="recalculateScores()"
                           style="width: 100%; padding: 8px; border-radius: 4px; border: none; font-size: 14px; font-weight: 600;">
                </div>
                <div>
                    <label style="display: block; font-size: 11px; margin-bottom: 5px; opacity: 0.9;">Yellow Highlight Threshold (Avg Score)</label>
                    <input type="number" id="yellow_threshold" value="0.4" step="0.05" min="0" max="5"
                           onchange="recalculateScores()"
                           style="width: 100%; padding: 8px; border-radius: 4px; border: none; font-size: 14px; font-weight: 600;">
                </div>
                <div>
                    <label style="display: block; font-size: 11px; margin-bottom: 5px; opacity: 0.9;">Green Highlight Threshold (Avg Score)</label>
                    <input type="number" id="green_threshold" value="0.7" step="0.05" min="0" max="5"
                           onchange="recalculateScores()"
                           style="width: 100%; padding: 8px; border-radius: 4px; border: none; font-size: 14px; font-weight: 600;">
                </div>
            </div>
            <div style="margin-top: 15px; text-align: right;">
                <button onclick="resetScoringMetrics()" 
                        style="padding: 8px 16px; background: white; color: #667eea; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">
                    üîÑ Reset to Defaults
                </button>
            </div>
        </div>

        <!-- Upcoming Games -->
        <div class="main-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #2d3748; margin: 0;">üîÆ Upcoming Games</h2>
                <div id="filterIndicator" style="display: none;">
                    <button onclick="filterByGameKey(null)" 
                            onmouseover="this.style.background='#f56565'" 
                            onmouseout="this.style.background='#fc8181'"
                            style="padding: 8px 16px; background: #fc8181; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition: background 0.2s;">
                        ‚úï Clear Filter
                    </button>
                </div>
            </div>
            <div id="upcomingGamesContent">
                <div class="empty-state">
                    <div class="empty-state-icon">üìÖ</div>
                    <h3>No Upcoming Games</h3>
                    <p>Run Phase 4 to fetch today and tomorrow's games.</p>
                </div>
            </div>
        </div>

        <!-- Historical Analysis Table -->
        <div class="main-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #2d3748;">üìä Historical Game Analysis</h2>
                <div style="display: flex; gap: 10px;">
                    <button id="viewByGameBtn" onclick="switchHistoricalView('game')" 
                            style="padding: 8px 16px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        By Game
                    </button>
                    <button id="viewByTeamBtn" onclick="switchHistoricalView('team')" 
                            style="padding: 8px 16px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        By Team
                    </button>
                    <button id="viewByPlayerBtn" onclick="switchHistoricalView('player')" 
                            style="padding: 8px 16px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        By Player
                    </button>
                </div>
            </div>
            <div class="legend" style="margin-bottom: 20px;">
                <strong>Legend:</strong>
                <div class="legend-item">
                    <span class="legend-color highlight-first-shot-made" style="padding: 4px 8px;">Bright Green</span>
                    <span>Took & made the FIRST shot of the game (<span id="legend_first_shot_made">+1.0</span>)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color highlight-first-shot-missed" style="padding: 4px 8px;">Bright Yellow</span>
                    <span>Took & missed the FIRST shot of the game (<span id="legend_first_shot_missed">+0.75</span>)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color highlight-first-fg-made" style="padding: 4px 8px;">Green</span>
                    <span>Made first FG (but wasn't first shot) (<span id="legend_first_fg_made">+0.5</span>)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color highlight-missed-shot" style="padding: 4px 8px;">Yellow</span>
                    <span>Missed shot before first FG (<span id="legend_missed_shot">+0.25</span>)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color highlight-free-throw" style="padding: 4px 8px;">Outline</span>
                    <span>Took free throws before first FG (<span id="legend_free_throw">+1.0</span>)</span>
                </div>
            </div>
            <div id="analysisContent">
                <div class="empty-state">
                    <div class="empty-state-icon">üèÄ</div>
                    <h3>No Analysis Data Available</h3>
                    <p>Click "Refresh Analysis" to load data from CSV files, or run the scraper first.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let analysisData = [];
        let pbpDataCache = null;
        let currentHistoricalView = 'game'; // 'game' or 'team'
        let selectedGameKey = null; // For filtering by game
        let upcomingGamesData = []; // Store upcoming games data
        let playerScoresData = {}; // Store player scores data
        let rawAnalysisData = null; // Store raw analysis data for recalculation

        function getScoringMetrics() {
            const getValue = (id, defaultVal) => {
                const val = document.getElementById(id).value;
                return val === '' ? defaultVal : parseFloat(val);
            };
            
            return {
                first_shot_made: getValue('score_first_shot_made', 1.0),
                first_shot_missed: getValue('score_first_shot_missed', 0.75),
                first_fg_made: getValue('score_first_fg_made', 0.5),
                missed_shot: getValue('score_missed_shot', 0.25),
                free_throw: getValue('score_free_throw', 1.0)
            };
        }

        function calculatePlayerScoresFromData(analysisData) {
            const metrics = getScoringMetrics();
            const scores = {};
            
            analysisData.forEach(game => {
                const highlights = game.highlights || {};
                const visitorStarters = game.visitor_starters || [];
                const homeStarters = game.home_starters || [];
                const visitorTeam = game.visitor_team || '';
                const homeTeam = game.home_team || '';
                const allStarters = [...visitorStarters, ...homeStarters];
                const gameKey = game.game_key || '';
                const gameDate = game.date || '';
                const gameMatchup = game.matchup || '';
                
                allStarters.forEach(player => {
                    if (!player || player === '') return;
                    
                    // Determine player's team
                    const playerTeam = visitorStarters.includes(player) ? visitorTeam : homeTeam;
                    
                    if (!scores[player]) {
                        scores[player] = {
                            shot_score: 0,
                            games_started: 0,
                            team: playerTeam,  // Store player's primary team
                            first_shot_made: 0,
                            first_shot_missed: 0,
                            first_fg_made: 0,
                            missed_shot: 0,
                            free_throw: 0,
                            game_details: []
                        };
                    }
                    
                    scores[player].games_started++;
                    
                    // Handle both old format (single string) and new format (array of strings)
                    const playerHighlights = highlights[player];
                    const highlightsList = Array.isArray(playerHighlights) ? playerHighlights : (playerHighlights ? [playerHighlights] : []);
                    
                    // Deduplicate free throws - only count once per game
                    const uniqueHighlights = [];
                    let hasFreeThrow = false;
                    highlightsList.forEach(hl => {
                        if (hl === 'free_throw') {
                            if (!hasFreeThrow) {
                                uniqueHighlights.push(hl);
                                hasFreeThrow = true;
                            }
                        } else {
                            uniqueHighlights.push(hl);
                        }
                    });
                    
                    // Calculate game score and actions
                    let gameScore = 0;
                    const actions = [];
                    
                    // Process ALL unique highlights for this player in this game
                    uniqueHighlights.forEach(highlightType => {
                        if (highlightType === 'first_shot_made') {
                            const actionScore = metrics.first_shot_made;
                            scores[player].shot_score += actionScore;
                            scores[player].first_shot_made++;
                            gameScore += actionScore;
                            actions.push({ type: 'first_shot_made', score: actionScore });
                        } else if (highlightType === 'first_shot_missed') {
                            const actionScore = metrics.first_shot_missed;
                            scores[player].shot_score += actionScore;
                            scores[player].first_shot_missed++;
                            gameScore += actionScore;
                            actions.push({ type: 'first_shot_missed', score: actionScore });
                        } else if (highlightType === 'first_fg_made') {
                            const actionScore = metrics.first_fg_made;
                            scores[player].shot_score += actionScore;
                            scores[player].first_fg_made++;
                            gameScore += actionScore;
                            actions.push({ type: 'first_fg_made', score: actionScore });
                        } else if (highlightType === 'missed_shot') {
                            const actionScore = metrics.missed_shot;
                            scores[player].shot_score += actionScore;
                            scores[player].missed_shot++;
                            gameScore += actionScore;
                            actions.push({ type: 'missed_shot', score: actionScore });
                        } else if (highlightType === 'free_throw') {
                            const actionScore = metrics.free_throw;
                            scores[player].shot_score += actionScore;
                            scores[player].free_throw++;
                            gameScore += actionScore;
                            actions.push({ type: 'free_throw', score: actionScore });
                        }
                    });
                    
                    // Record game details
                    scores[player].game_details.push({
                        game_key: gameKey,
                        date: gameDate,
                        matchup: gameMatchup,
                        team: playerTeam,  // Include player's team for this game
                        actions: actions,
                        game_score: gameScore
                    });
                });
            });
            
            return scores;
        }

        function recalculateScores() {
            if (!rawAnalysisData) return;
            
            console.log('Recalculating scores with new metrics...');
            
            // Update legend values
            const metrics = getScoringMetrics();
            console.log('New metrics:', metrics);
            
            document.getElementById('legend_first_shot_made').textContent = `+${metrics.first_shot_made.toFixed(2)}`;
            document.getElementById('legend_first_shot_missed').textContent = `+${metrics.first_shot_missed.toFixed(2)}`;
            document.getElementById('legend_first_fg_made').textContent = `+${metrics.first_fg_made.toFixed(2)}`;
            document.getElementById('legend_missed_shot').textContent = `+${metrics.missed_shot.toFixed(2)}`;
            document.getElementById('legend_free_throw').textContent = `+${metrics.free_throw.toFixed(2)}`;
            
            // Recalculate player scores with new metrics
            playerScoresData = calculatePlayerScoresFromData(rawAnalysisData);
            console.log('Recalculated player scores:', Object.keys(playerScoresData).length, 'players');
            
            // Re-render upcoming games and historical views
            if (upcomingGamesData.length > 0) {
                console.log('Re-rendering upcoming games...');
                renderUpcomingGames(upcomingGamesData, playerScoresData);
            }
            
            if (currentHistoricalView === 'game') {
                console.log('Re-rendering historical analysis (By Game view)...');
                renderAnalysisTable(rawAnalysisData);
            } else if (currentHistoricalView === 'team') {
                console.log('Re-rendering historical analysis (By Team view)...');
                renderAnalysisTableByTeam(rawAnalysisData);
            } else if (currentHistoricalView === 'player') {
                console.log('Re-rendering historical analysis (By Player view)...');
                renderAnalysisTableByPlayer(rawAnalysisData);
            }
            
            console.log('Recalculation complete!');
        }

        function resetScoringMetrics() {
            document.getElementById('score_first_shot_made').value = 1.0;
            document.getElementById('score_first_shot_missed').value = 0.75;
            document.getElementById('score_first_fg_made').value = 0.5;
            document.getElementById('score_missed_shot').value = 0.25;
            document.getElementById('score_free_throw').value = 1.0;
            document.getElementById('top_players_threshold').value = 0.25;
            document.getElementById('yellow_threshold').value = 0.4;
            document.getElementById('green_threshold').value = 0.7;
            recalculateScores();
        }
        
        function getTopPlayersThreshold() {
            const val = document.getElementById('top_players_threshold').value;
            return val === '' ? 0.25 : parseFloat(val);
        }
        
        function getYellowThreshold() {
            const val = document.getElementById('yellow_threshold').value;
            return val === '' ? 0.4 : parseFloat(val);
        }
        
        function getGreenThreshold() {
            const val = document.getElementById('green_threshold').value;
            return val === '' ? 0.7 : parseFloat(val);
        }

        async function loadPBPData() {
            if (pbpDataCache) return pbpDataCache;
            
            try {
                const response = await fetch('/api/pbp');
                const data = await response.json();
                pbpDataCache = data.pbp_data || [];
                return pbpDataCache;
            } catch (error) {
                console.error('Error loading PBP data:', error);
                return [];
            }
        }

        async function toggleGamePBP(gameKey, rowIndex) {
            const gameRow = document.querySelector(`tr[data-game-key="${gameKey}"]`);
            const detailRow = document.getElementById(`pbp-detail-${rowIndex}`);
            const detailContent = document.getElementById(`pbp-content-${rowIndex}`);
            
            // Toggle expanded state
            const isExpanded = gameRow.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse
                gameRow.classList.remove('expanded');
                detailContent.classList.remove('expanded');
                setTimeout(() => {
                    detailRow.classList.remove('show');
                }, 300);
            } else {
                // Expand
                gameRow.classList.add('expanded');
                detailRow.classList.add('show');
                
                // Load PBP data if not already loaded
                if (!detailContent.dataset.loaded) {
                    detailContent.innerHTML = '<div class="pbp-loading"><div class="spinner"></div> Loading play-by-play data...</div>';
                    
                    setTimeout(async () => {
                        const allPBP = await loadPBPData();
                        const gamePBP = allPBP.filter(play => play.game_key === gameKey);
                        
                        if (gamePBP.length > 0) {
                            const pbpHTML = `
                                <h3 style="margin-bottom: 15px; color: #2d3748;">Play-by-Play: ${gameKey}</h3>
                                <table class="pbp-table">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Visitor Play</th>
                                            <th>Home Play</th>
                                            <th>Score</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${gamePBP.map(play => `
                                            <tr>
                                                <td>${play.time || ''}</td>
                                                <td>${play.visitor_play || ''}</td>
                                                <td>${play.home_play || ''}</td>
                                                <td>${play.score || ''}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            `;
                            detailContent.innerHTML = pbpHTML;
                        } else {
                            detailContent.innerHTML = '<div class="pbp-loading">No play-by-play data available for this game.</div>';
                        }
                        
                        detailContent.dataset.loaded = 'true';
                        detailContent.classList.add('expanded');
                    }, 50);
                } else {
                    // Already loaded, just expand
                    setTimeout(() => {
                        detailContent.classList.add('expanded');
                    }, 50);
                }
            }
        }

        async function toggleTeamGamePBP(gameKey, teamCode, gameIndex) {
            const rowId = `team-game-${teamCode}-${gameIndex}`;
            const detailRowId = `team-pbp-detail-${teamCode}-${gameIndex}`;
            const detailContentId = `team-pbp-content-${teamCode}-${gameIndex}`;
            
            const gameRow = document.getElementById(rowId);
            const detailRow = document.getElementById(detailRowId);
            const detailContent = document.getElementById(detailContentId);
            
            // Toggle expanded state
            const isExpanded = gameRow.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse
                gameRow.classList.remove('expanded');
                detailContent.classList.remove('expanded');
                setTimeout(() => {
                    detailRow.classList.remove('show');
                }, 300);
            } else {
                // Expand
                gameRow.classList.add('expanded');
                detailRow.classList.add('show');
                
                // Load PBP data if not already loaded
                if (!detailContent.dataset.loaded) {
                    detailContent.innerHTML = '<div class="pbp-loading"><div class="spinner"></div> Loading play-by-play data...</div>';
                    
                    setTimeout(async () => {
                        const allPBP = await loadPBPData();
                        const gamePBP = allPBP.filter(play => play.game_key === gameKey);
                        
                        if (gamePBP.length > 0) {
                            const pbpHTML = `
                                <h3 style="margin-bottom: 15px; color: #2d3748;">Play-by-Play: ${gameKey}</h3>
                                <table class="pbp-table">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Visitor Play</th>
                                            <th>Home Play</th>
                                            <th>Score</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${gamePBP.map(play => `
                                            <tr>
                                                <td>${play.time || ''}</td>
                                                <td>${play.visitor_play || ''}</td>
                                                <td>${play.home_play || ''}</td>
                                                <td>${play.score || ''}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            `;
                            detailContent.innerHTML = pbpHTML;
                        } else {
                            detailContent.innerHTML = '<div class="pbp-loading">No play-by-play data available for this game.</div>';
                        }
                        
                        detailContent.dataset.loaded = 'true';
                        detailContent.classList.add('expanded');
                    }, 50);
                } else {
                    // Already loaded, just expand
                    setTimeout(() => {
                        detailContent.classList.add('expanded');
                    }, 50);
                }
            }
        }

        async function refreshAnalysis() {
            const analysisContent = document.getElementById('analysisContent');
            const upcomingContent = document.getElementById('upcomingGamesContent');
            
            console.log('[FSA] Starting refreshAnalysis...');
            analysisContent.innerHTML = '<div class="loading"><div class="spinner"></div> Loading analysis...</div>';
            upcomingContent.innerHTML = '<div class="loading"><div class="spinner"></div> Loading upcoming games...</div>';

            try {
                console.log('[FSA] Fetching data from /api/analysis...');
                const response = await fetch('/api/analysis?from_csv=true');
                const data = await response.json();
                console.log('[FSA] Received data:', {
                    analysis_count: data.analysis?.length || 0,
                    player_scores_count: Object.keys(data.player_scores || {}).length,
                    upcoming_games_count: data.upcoming_games?.length || 0
                });

                if (data.error) {
                    console.error('[FSA] API returned error:', data.error);
                    analysisContent.innerHTML = `
                        <div class="error-message">
                            <strong>Error:</strong> ${data.error}
                        </div>
                        <div class="empty-state">
                            <div class="empty-state-icon">‚ö†Ô∏è</div>
                            <h3>Could not load analysis</h3>
                            <p>Make sure you have run the scraper and CSV files exist.</p>
                        </div>
                    `;
                    upcomingContent.innerHTML = '<div class="empty-state">No upcoming games available.</div>';
                    return;
                }

                // Store raw analysis data for recalculation
                rawAnalysisData = data.analysis || [];
                console.log('[FSA] Stored rawAnalysisData:', rawAnalysisData.length, 'games');
                
                // Calculate player scores using current metrics
                console.log('[FSA] Calculating player scores from data...');
                playerScoresData = calculatePlayerScoresFromData(rawAnalysisData);
                console.log('[FSA] Calculated playerScoresData:', Object.keys(playerScoresData).length, 'players');
                
                // Check if game_details exists
                const firstPlayer = Object.keys(playerScoresData)[0];
                if (firstPlayer) {
                    console.log('[FSA] First player sample:', firstPlayer, playerScoresData[firstPlayer]);
                }

                // Render upcoming games with calculated player scores
                if (data.upcoming_games && data.upcoming_games.length > 0) {
                    console.log('[FSA] Rendering upcoming games...');
                    renderUpcomingGames(data.upcoming_games, playerScoresData);
                } else {
                    console.log('[FSA] No upcoming games to render');
                    upcomingContent.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <h3>No Upcoming Games</h3>
                            <p>Run Phase 4 to fetch today and tomorrow's games.</p>
                        </div>
                    `;
                }

                // Render historical analysis table
                if (rawAnalysisData.length > 0) {
                    console.log('[FSA] Rendering historical analysis table...');
                    renderAnalysisTable(rawAnalysisData);
                    console.log('[FSA] Historical analysis rendered successfully');
                } else {
                    console.log('[FSA] No historical data to render');
                    analysisContent.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <h3>No Historical Data</h3>
                            <p>Run Phases 1-3 to collect game data first.</p>
                        </div>
                    `;
                }
                
                console.log('[FSA] refreshAnalysis completed successfully');

            } catch (error) {
                console.error('[FSA] Error in refreshAnalysis:', error);
                console.error('[FSA] Error stack:', error.stack);
                analysisContent.innerHTML = `
                    <div class="error-message">
                        <strong>Error:</strong> ${error.message}
                        <br><small>Check browser console for details</small>
                    </div>
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <h3>Failed to Load Analysis</h3>
                        <p>Please try again or check the console for details.</p>
                    </div>
                `;
                upcomingContent.innerHTML = '<div class="empty-state">Error loading upcoming games.</div>';
            }
        }

        function filterByGameKey(gameKey) {
            if (selectedGameKey === gameKey || gameKey === null) {
                // Toggle off - remove filter
                selectedGameKey = null;
            } else {
                // Apply filter
                selectedGameKey = gameKey;
            }
            
            // Show/hide filter indicator
            const filterIndicator = document.getElementById('filterIndicator');
            if (selectedGameKey) {
                filterIndicator.style.display = 'block';
            } else {
                filterIndicator.style.display = 'none';
            }
            
            // Re-render both tables with the filter
            renderUpcomingGames(upcomingGamesData, playerScoresData);
            
            if (currentHistoricalView === 'team') {
                renderAnalysisTableByTeam(analysisData);
            } else if (currentHistoricalView === 'player') {
                renderAnalysisTableByPlayer(analysisData);
            } else {
                renderAnalysisTable(analysisData);
            }
        }

        function renderUpcomingGames(upcomingGames, playerScores) {
            upcomingGamesData = upcomingGames;
            playerScoresData = playerScores;
            
            const upcomingContent = document.getElementById('upcomingGamesContent');
            
            const getPlayerScoreDisplay = (playerName) => {
                if (!playerName || playerName === '') return '';
                const score = playerScores[playerName];
                if (score) {
                    return `${score.shot_score.toFixed(1)}/${score.games_started}`;
                }
                return '0.0/0';
            };
            
            const getScoreStyle = (playerName) => {
                if (!playerName || playerName === '') return { scoreStyle: '', cellStyle: '' };
                const score = playerScores[playerName];
                
                if (!score || score.shot_score === 0) {
                    // Grey out the entire cell for zero scores
                    return { 
                        scoreStyle: '', 
                        cellStyle: 'opacity: 0.4; background: #f3f4f6;' 
                    };
                }
                
                if (score.shot_score > 0) {
                    const ratio = score.shot_score / score.games_started;
                    const greenThreshold = getGreenThreshold();
                    const yellowThreshold = getYellowThreshold();
                    
                    if (ratio >= greenThreshold) {
                        return { 
                            scoreStyle: 'background: #48bb78; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;',
                            cellStyle: 'background: #d1fae5;' // Light green background for whole cell
                        };
                    }
                    if (ratio >= yellowThreshold) {
                        return { 
                            scoreStyle: 'background: #ecc94b; color: #2d3748; padding: 2px 6px; border-radius: 4px; font-weight: 600;',
                            cellStyle: 'background: #fef3c7;' // Light yellow background for whole cell
                        };
                    }
                }
                return { scoreStyle: '', cellStyle: '' };
            };
            
            // Generate tooltip HTML with player stats breakdown
            const generatePlayerTooltip = (playerName) => {
                if (!playerName || playerName === '') return '';
                
                const stats = playerScores[playerName];
                if (!stats) return '';
                
                return `
                    <div class="player-tooltip">
                        <div style="font-weight: 700; margin-bottom: 8px; font-size: 13px; border-bottom: 2px solid rgba(255,255,255,0.2); padding-bottom: 5px;">${playerName}</div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Games Started:</span>
                            <span class="tooltip-value">${stats.games_started || 0}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Took & Made First Shot:</span>
                            <span class="tooltip-value">${stats.first_shot_made || 0}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Took & Missed First Shot:</span>
                            <span class="tooltip-value">${stats.first_shot_missed || 0}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Made First FG (wasn't first shot):</span>
                            <span class="tooltip-value">${stats.first_fg_made || 0}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Missed Shot Before First FG:</span>
                            <span class="tooltip-value">${stats.missed_shot || 0}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">Took FTs:</span>
                            <span class="tooltip-value">${stats.free_throw || 0}</span>
                        </div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 2px solid rgba(255,255,255,0.2); font-weight: 700;">
                            <div class="tooltip-row">
                                <span class="tooltip-label">Total Score:</span>
                                <span class="tooltip-value" style="color: #fbbf24;">${stats.shot_score.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `;
            };
            
            // Format player name: First name on line 1, Last name(s) on line 2, max 15 chars per line
            const formatPlayerName = (playerName) => {
                if (!playerName || playerName === '') return '<div></div>';
                
                const parts = playerName.trim().split(' ');
                if (parts.length === 0) return '<div></div>';
                
                const firstName = parts[0];
                const lastName = parts.slice(1).join(' ');
                
                const truncate = (str, maxLen) => {
                    if (str.length <= maxLen) return str;
                    return str.substring(0, maxLen - 3) + '...';
                };
                
                return `
                    <div style="text-align: center; line-height: 1.2;">
                        <div style="font-size: 10px;">${truncate(firstName, 15)}</div>
                        <div style="font-size: 10px;">${lastName ? truncate(lastName, 15) : ''}</div>
                    </div>
                `;
            };
            
            // Filter games if a game key is selected
            const displayGames = selectedGameKey 
                ? upcomingGames.filter(g => g.game_key === selectedGameKey)
                : upcomingGames;
            
            // Group games by date
            const gamesByDate = {};
            displayGames.forEach(game => {
                const date = game.date || 'Unknown Date';
                if (!gamesByDate[date]) {
                    gamesByDate[date] = [];
                }
                gamesByDate[date].push(game);
            });
            
            // Sort dates (today first, then tomorrow)
            const sortedDates = Object.keys(gamesByDate).sort();
            
            // Get threshold once for use in headers
            const threshold = getTopPlayersThreshold();
            
            // Render games grouped by date with collapsible sections
            const html = sortedDates.map(date => {
                const games = gamesByDate[date];
                const dateId = date.replace(/\//g, '-');
                
                return `
                    <div style="margin-bottom: 15px;">
                        <div style="background: #667eea; color: white; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; justify-content: space-between; align-items: center;" 
                             onclick="toggleDateSection('${dateId}')">
                            <span><span id="icon-${dateId}" style="font-size: 14px; margin-right: 8px;">‚ñº</span>${date} (${games.length} game${games.length !== 1 ? 's' : ''})</span>
                        </div>
                        <div id="date-${dateId}" style="margin-top: 10px;">
                            <div style="overflow-x: auto;">
                                <table class="data-table">
                                                    <thead>
                                                        <tr>
                                                            <th title="Click on matchup to filter data" style="cursor: pointer;">Matchup üîç</th>
                                                            <th>V Starter 1</th>
                                                            <th>V Starter 2</th>
                                                            <th>V Starter 3</th>
                                                            <th>V Starter 4</th>
                                                            <th>V Starter 5</th>
                                                            <th>H Starter 1</th>
                                                            <th>H Starter 2</th>
                                                            <th>H Starter 3</th>
                                                            <th>H Starter 4</th>
                                                            <th>H Starter 5</th>
                                                            <th style="min-width: 120px;">Top Players (>${threshold.toFixed(2)})</th>
                                                        </tr>
                                                    </thead>
                                    <tbody>
                                        ${games.map(game => {
                                            const isSelected = selectedGameKey === game.game_key;
                                            const matchupStyle = isSelected 
                                                ? 'cursor: pointer; color: #667eea; font-weight: 700; text-decoration: underline; background: #eef2ff;'
                                                : 'cursor: pointer; color: #667eea; font-weight: 600; text-decoration: underline;';
                                            
                                            // Collect all players from this game and their scores
                                            const allPlayers = [
                                                game.V_s1, game.V_s2, game.V_s3, game.V_s4, game.V_s5,
                                                game.H_s1, game.H_s2, game.H_s3, game.H_s4, game.H_s5
                                            ].filter(p => p && p !== '');
                                            
                                            // Filter players with avg score > threshold
                                            const topPlayers = allPlayers
                                                .map(player => {
                                                    const score = playerScores[player];
                                                    if (score && score.games_started > 0) {
                                                        const avgScore = score.shot_score / score.games_started;
                                                        return { name: player, avgScore: avgScore };
                                                    }
                                                    return null;
                                                })
                                                .filter(p => p && p.avgScore > threshold)
                                                .sort((a, b) => b.avgScore - a.avgScore);
                                            
                                            const topPlayersHTML = topPlayers.length > 0 
                                                ? topPlayers.map(p => `
                                                    <div style="font-size: 9px; padding: 2px 0; white-space: nowrap;">
                                                        ${p.name}: <strong>${p.avgScore.toFixed(2)}</strong>
                                                    </div>
                                                `).join('')
                                                : '<div style="font-size: 9px; color: #9ca3af;">None</div>';
                                            
                                            const v1Style = getScoreStyle(game.V_s1);
                                            const v2Style = getScoreStyle(game.V_s2);
                                            const v3Style = getScoreStyle(game.V_s3);
                                            const v4Style = getScoreStyle(game.V_s4);
                                            const v5Style = getScoreStyle(game.V_s5);
                                            const h1Style = getScoreStyle(game.H_s1);
                                            const h2Style = getScoreStyle(game.H_s2);
                                            const h3Style = getScoreStyle(game.H_s3);
                                            const h4Style = getScoreStyle(game.H_s4);
                                            const h5Style = getScoreStyle(game.H_s5);
                                            
                                            return `
                                                <tr>
                                                    <td style="${matchupStyle}" onclick="filterByGameKey('${game.game_key || ''}')" title="Click to filter">${game.matchup || ''}</td>
                                                    <td class="player-name" style="padding: 4px 8px; ${v1Style.cellStyle}">
                                                        ${formatPlayerName(game.V_s1)}
                                                        <div style="font-size: 8px; color: #667eea; ${v1Style.scoreStyle} margin-top: 2px; text-align: center;">${getPlayerScoreDisplay(game.V_s1)}</div>
                                                        ${generatePlayerTooltip(game.V_s1)}
                                                    </td>
                                                    <td class="player-name" style="padding: 4px 8px; ${v2Style.cellStyle}">
                                                        ${formatPlayerName(game.V_s2)}
                                                        <div style="font-size: 8px; color: #667eea; ${v2Style.scoreStyle} margin-top: 2px; text-align: center;">${getPlayerScoreDisplay(game.V_s2)}</div>
                                                        ${generatePlayerTooltip(game.V_s2)}
                                                    </td>
                                                    <td class="player-name" style="padding: 4px 8px; ${v3Style.cellStyle}">
                                                        ${formatPlayerName(game.V_s3)}
                                                        <div style="font-size: 8px; color: #667eea; ${v3Style.scoreStyle} margin-top: 2px; text-align: center;">${getPlayerScoreDisplay(game.V_s3)}</div>
                                                        ${generatePlayerTooltip(game.V_s3)}
                                                    </td>
                                                    <td class="player-name" style="padding: 4px 8px; ${v4Style.cellStyle}">
                                                        ${formatPlayerName(game.V_s4)}
                                                        <div style="font-size: 8px; color: #667eea; ${v4Style.scoreStyle} margin-top: 2px; text-align: center;">${getPlayerScoreDisplay(game.V_s4)}</div>
                                                        ${generatePlayerTooltip(game.V_s4)}
                                                    </td>
                                                    <td class="player-name" style="padding: 4px 8px; ${v5Style.cellStyle}">
                                                        ${formatPlayerName(game.V_s5)}
                                                        <div style="font-size: 8px; color: #667eea; ${v5Style.scoreStyle} margin-top: 2px; text-align: center;">${getPlayerScoreDisplay(game.V_s5)}</div>
                                                        ${generatePlayerTooltip(game.V_s5)}
                                                    </td>
                                                    <td class="player-name" style="padding: 4px 8px; ${h1Style.cellStyle}">
                                                        ${formatPlayerName(game.H_s1)}
                                                        <div style="font-size: 8px; color: #48bb78; ${h1Style.scoreStyle} margin-top: 2px; text-align: center;">${getPlayerScoreDisplay(game.H_s1)}</div>
                                                        ${generatePlayerTooltip(game.H_s1)}
                                                    </td>
                                                    <td class="player-name" style="padding: 4px 8px; ${h2Style.cellStyle}">
                                                        ${formatPlayerName(game.H_s2)}
                                                        <div style="font-size: 8px; color: #48bb78; ${h2Style.scoreStyle} margin-top: 2px; text-align: center;">${getPlayerScoreDisplay(game.H_s2)}</div>
                                                        ${generatePlayerTooltip(game.H_s2)}
                                                    </td>
                                                    <td class="player-name" style="padding: 4px 8px; ${h3Style.cellStyle}">
                                                        ${formatPlayerName(game.H_s3)}
                                                        <div style="font-size: 8px; color: #48bb78; ${h3Style.scoreStyle} margin-top: 2px; text-align: center;">${getPlayerScoreDisplay(game.H_s3)}</div>
                                                        ${generatePlayerTooltip(game.H_s3)}
                                                    </td>
                                                    <td class="player-name" style="padding: 4px 8px; ${h4Style.cellStyle}">
                                                        ${formatPlayerName(game.H_s4)}
                                                        <div style="font-size: 8px; color: #48bb78; ${h4Style.scoreStyle} margin-top: 2px; text-align: center;">${getPlayerScoreDisplay(game.H_s4)}</div>
                                                        ${generatePlayerTooltip(game.H_s4)}
                                                    </td>
                                                    <td class="player-name" style="padding: 4px 8px; ${h5Style.cellStyle}">
                                                        ${formatPlayerName(game.H_s5)}
                                                        <div style="font-size: 8px; color: #48bb78; ${h5Style.scoreStyle} margin-top: 2px; text-align: center;">${getPlayerScoreDisplay(game.H_s5)}</div>
                                                        ${generatePlayerTooltip(game.H_s5)}
                                                    </td>
                                                    <td style="padding: 6px; vertical-align: top; background: #f7fafc;">
                                                        ${topPlayersHTML}
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            upcomingContent.innerHTML = html;
        }
        
        function toggleDateSection(dateId) {
            const section = document.getElementById(`date-${dateId}`);
            const icon = document.getElementById(`icon-${dateId}`);
            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.textContent = '‚ñº';
            } else {
                section.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }

        function getPrimaryHighlight(playerHighlights) {
            // Get the most significant highlight from a list
            // Priority: first_shot_made > first_shot_missed > first_fg_made > missed_shot > free_throw
            if (!playerHighlights) return null;
            
            const highlightsList = Array.isArray(playerHighlights) ? playerHighlights : [playerHighlights];
            
            if (highlightsList.includes('first_shot_made')) return 'first_shot_made';
            if (highlightsList.includes('first_shot_missed')) return 'first_shot_missed';
            if (highlightsList.includes('first_fg_made')) return 'first_fg_made';
            if (highlightsList.includes('missed_shot')) return 'missed_shot';
            if (highlightsList.includes('free_throw')) return 'free_throw';
            // Legacy support
            if (highlightsList.includes('green')) return 'green';
            if (highlightsList.includes('yellow')) return 'yellow';
            
            return null;
        }

        function renderAnalysisTable(analysis) {
            analysisData = analysis;
            const analysisContent = document.getElementById('analysisContent');
            
            // Get teams to filter by (if a game is selected)
            let filterTeams = null;
            if (selectedGameKey) {
                // Extract teams from the selected game key (format: VIS@HOM_DATE)
                const matchupPart = selectedGameKey.split('_')[0]; // e.g., "OKC@DAL"
                if (matchupPart) {
                    const teams = matchupPart.split('@'); // ["OKC", "DAL"]
                    if (teams.length === 2) {
                        filterTeams = new Set(teams);
                    }
                }
            }
            
            // Filter analysis if needed
            const displayAnalysis = filterTeams 
                ? analysis.filter(game => {
                    return filterTeams.has(game.visitor_team) || filterTeams.has(game.home_team);
                })
                : analysis;

            const html = `
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Game Key</th>
                                <th>Date</th>
                                <th>Matchup</th>
                                <th>Visitor Starter 1</th>
                                <th>Visitor Starter 2</th>
                                <th>Visitor Starter 3</th>
                                <th>Visitor Starter 4</th>
                                <th>Visitor Starter 5</th>
                                <th>Home Starter 1</th>
                                <th>Home Starter 2</th>
                                <th>Home Starter 3</th>
                                <th>Home Starter 4</th>
                                <th>Home Starter 5</th>
                                <th>PBP Plays</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${displayAnalysis.map((game, index) => {
                                const highlights = game.highlights || {};
                                
                                const getHighlight = (playerName) => {
                                    const playerHighlights = highlights[playerName];
                                    const primaryHighlight = getPrimaryHighlight(playerHighlights);
                                    
                                    if (primaryHighlight === 'first_shot_made') return 'highlight-first-shot-made';
                                    if (primaryHighlight === 'first_shot_missed') return 'highlight-first-shot-missed';
                                    if (primaryHighlight === 'first_fg_made') return 'highlight-first-fg-made';
                                    if (primaryHighlight === 'missed_shot') return 'highlight-missed-shot';
                                    if (primaryHighlight === 'free_throw') return 'highlight-free-throw';
                                    // Legacy support
                                    if (primaryHighlight === 'green') return 'highlight-green';
                                    if (primaryHighlight === 'yellow') return 'highlight-yellow';
                                    return '';
                                };
                                
                                const vStarters = game.visitor_starters || [];
                                const hStarters = game.home_starters || [];
                                const gameKey = game.game_key || '';
                                
                                // Generate tooltip for each player
                                const generateTooltip = (playerName) => {
                                    if (!playerName || playerName === '') return '';
                                    const stats = playerScoresData[playerName];
                                    if (!stats) return '';
                                    
                                    return `
                                        <div class="player-tooltip">
                                            <div style="font-weight: 700; margin-bottom: 8px; font-size: 13px; border-bottom: 2px solid rgba(255,255,255,0.2); padding-bottom: 5px;">${playerName}</div>
                                            <div class="tooltip-row">
                                                <span class="tooltip-label">Games Started:</span>
                                                <span class="tooltip-value">${stats.games_started || 0}</span>
                                            </div>
                                            <div class="tooltip-row">
                                                <span class="tooltip-label">Took & Made First Shot:</span>
                                                <span class="tooltip-value">${stats.first_shot_made || 0}</span>
                                            </div>
                                            <div class="tooltip-row">
                                                <span class="tooltip-label">Took & Missed First Shot:</span>
                                                <span class="tooltip-value">${stats.first_shot_missed || 0}</span>
                                            </div>
                                            <div class="tooltip-row">
                                                <span class="tooltip-label">Made First FG (wasn't first shot):</span>
                                                <span class="tooltip-value">${stats.first_fg_made || 0}</span>
                                            </div>
                                            <div class="tooltip-row">
                                                <span class="tooltip-label">Missed Shot Before First FG:</span>
                                                <span class="tooltip-value">${stats.missed_shot || 0}</span>
                                            </div>
                                            <div class="tooltip-row">
                                                <span class="tooltip-label">Took FTs:</span>
                                                <span class="tooltip-value">${stats.free_throw || 0}</span>
                                            </div>
                                            <div style="margin-top: 8px; padding-top: 8px; border-top: 2px solid rgba(255,255,255,0.2); font-weight: 700;">
                                                <div class="tooltip-row">
                                                    <span class="tooltip-label">Total Score:</span>
                                                    <span class="tooltip-value" style="color: #fbbf24;">${stats.shot_score.toFixed(2)}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                };
                                
                                return `
                                    <tr class="game-row" data-game-key="${gameKey}" onclick="toggleGamePBP('${gameKey}', ${index})">
                                        <td><span class="expand-icon">‚ñ∂</span>${gameKey}</td>
                                        <td>${game.date || ''}</td>
                                        <td>${game.matchup || ''}</td>
                                        <td class="player-name ${getHighlight(vStarters[0])}">${vStarters[0] || ''}${generateTooltip(vStarters[0])}</td>
                                        <td class="player-name ${getHighlight(vStarters[1])}">${vStarters[1] || ''}${generateTooltip(vStarters[1])}</td>
                                        <td class="player-name ${getHighlight(vStarters[2])}">${vStarters[2] || ''}${generateTooltip(vStarters[2])}</td>
                                        <td class="player-name ${getHighlight(vStarters[3])}">${vStarters[3] || ''}${generateTooltip(vStarters[3])}</td>
                                        <td class="player-name ${getHighlight(vStarters[4])}">${vStarters[4] || ''}${generateTooltip(vStarters[4])}</td>
                                        <td class="player-name ${getHighlight(hStarters[0])}">${hStarters[0] || ''}${generateTooltip(hStarters[0])}</td>
                                        <td class="player-name ${getHighlight(hStarters[1])}">${hStarters[1] || ''}${generateTooltip(hStarters[1])}</td>
                                        <td class="player-name ${getHighlight(hStarters[2])}">${hStarters[2] || ''}${generateTooltip(hStarters[2])}</td>
                                        <td class="player-name ${getHighlight(hStarters[3])}">${hStarters[3] || ''}${generateTooltip(hStarters[3])}</td>
                                        <td class="player-name ${getHighlight(hStarters[4])}">${hStarters[4] || ''}${generateTooltip(hStarters[4])}</td>
                                        <td>${game.pbp_count || 0}</td>
                                    </tr>
                                    <tr class="pbp-detail-row" id="pbp-detail-${index}">
                                        <td colspan="14" class="pbp-detail-cell">
                                            <div class="pbp-detail-content" id="pbp-content-${index}">
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            analysisContent.innerHTML = html;
        }

        // Auto-load on page load
        function switchHistoricalView(viewType) {
            currentHistoricalView = viewType;
            
            // Update button styles
            const gameBtn = document.getElementById('viewByGameBtn');
            const teamBtn = document.getElementById('viewByTeamBtn');
            const playerBtn = document.getElementById('viewByPlayerBtn');
            
            // Reset all buttons
            gameBtn.style.background = 'white';
            gameBtn.style.color = '#667eea';
            teamBtn.style.background = 'white';
            teamBtn.style.color = '#667eea';
            playerBtn.style.background = 'white';
            playerBtn.style.color = '#667eea';
            
            if (viewType === 'game') {
                gameBtn.style.background = '#667eea';
                gameBtn.style.color = 'white';
                renderAnalysisTable(analysisData);
            } else if (viewType === 'team') {
                teamBtn.style.background = '#667eea';
                teamBtn.style.color = 'white';
                renderAnalysisTableByTeam(analysisData);
            } else if (viewType === 'player') {
                playerBtn.style.background = '#667eea';
                playerBtn.style.color = 'white';
                renderAnalysisTableByPlayer(analysisData);
            }
        }

        function renderAnalysisTableByTeam(analysis) {
            const analysisContent = document.getElementById('analysisContent');
            
            // Get teams to filter by (if a game is selected)
            let filterTeams = null;
            if (selectedGameKey) {
                // Extract teams from the selected game key (format: VIS@HOM_DATE)
                const matchupPart = selectedGameKey.split('_')[0]; // e.g., "OKC@DAL"
                if (matchupPart) {
                    const teams = matchupPart.split('@'); // ["OKC", "DAL"]
                    if (teams.length === 2) {
                        filterTeams = new Set(teams);
                    }
                }
            }
            
            // Group games by team
            const teamData = {};
            
            analysis.forEach(game => {
                const visitorTeam = game.visitor_team;
                const homeTeam = game.home_team;
                
                // Process visitor team
                if (visitorTeam && (!filterTeams || filterTeams.has(visitorTeam))) {
                    if (!teamData[visitorTeam]) {
                        teamData[visitorTeam] = {
                            teamCode: visitorTeam,
                            games: []
                        };
                    }
                    teamData[visitorTeam].games.push({
                        ...game,
                        starters: game.visitor_starters || [],
                        isHome: false
                    });
                }
                
                // Process home team
                if (homeTeam && (!filterTeams || filterTeams.has(homeTeam))) {
                    if (!teamData[homeTeam]) {
                        teamData[homeTeam] = {
                            teamCode: homeTeam,
                            games: []
                        };
                    }
                    teamData[homeTeam].games.push({
                        ...game,
                        starters: game.home_starters || [],
                        isHome: true
                    });
                }
            });
            
            // Sort teams alphabetically
            const sortedTeams = Object.keys(teamData).sort();
            
            let html = '<div style="overflow-x: auto;">';
            
            sortedTeams.forEach(teamCode => {
                const team = teamData[teamCode];
                const totalGames = team.games.length;
                
                                // Build roster from all games to get unique starters
                                const rosterMap = {};
                                team.games.forEach(game => {
                                    game.starters.forEach(player => {
                                        if (player && player !== '') {
                                            if (!rosterMap[player]) {
                                                rosterMap[player] = {
                                                    name: player,
                                                    games: 0,
                                                    score: 0
                                                };
                                            }
                                            rosterMap[player].games++;
                                            
                                            // Check highlights and add score (using dynamic metrics)
                                            const highlights = game.highlights || {};
                                            const playerHighlights = highlights[player];
                                            const highlightsList = Array.isArray(playerHighlights) ? playerHighlights : (playerHighlights ? [playerHighlights] : []);
                                            const metrics = getScoringMetrics();
                                            
                                            // Process ALL highlights for this player in this game
                                            highlightsList.forEach(highlightType => {
                                                if (highlightType === 'first_shot_made') {
                                                    rosterMap[player].score += metrics.first_shot_made;
                                                } else if (highlightType === 'first_shot_missed') {
                                                    rosterMap[player].score += metrics.first_shot_missed;
                                                } else if (highlightType === 'first_fg_made') {
                                                    rosterMap[player].score += metrics.first_fg_made;
                                                } else if (highlightType === 'missed_shot') {
                                                    rosterMap[player].score += metrics.missed_shot;
                                                } else if (highlightType === 'free_throw') {
                                                    rosterMap[player].score += metrics.free_throw;
                                                }
                                                // Legacy support
                                                else if (highlightType === 'green') {
                                                    rosterMap[player].score += metrics.first_fg_made;
                                                } else if (highlightType === 'yellow') {
                                                    rosterMap[player].score += metrics.missed_shot;
                                                }
                                            });
                                        }
                                    });
                                });
                                
                                const roster = Object.values(rosterMap).sort((a, b) => b.score - a.score || b.games - a.games);
                
                html += `
                    <div style="margin-bottom: 30px; border: 2px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                             onclick="toggleTeamDetails('team_${teamCode}')">
                            <div>
                                <h3 style="margin: 0; font-size: 18px;">üèÄ ${teamCode}</h3>
                                <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">${totalGames} games ‚Ä¢ ${roster.length} players</p>
                            </div>
                            <span id="team_${teamCode}_arrow" style="font-size: 24px; transition: transform 0.3s;">‚ñº</span>
                        </div>
                        
                        <div id="team_${teamCode}_details" style="display: none; padding: 20px; background: #f7fafc;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <!-- Aggregated Player Stats -->
                                <div>
                                    <h4 style="margin: 0 0 15px 0; color: #2d3748; font-size: 15px;">üìä Aggregated Player Stats</h4>
                                    <table class="data-table" style="margin-bottom: 0; font-size: 12px;">
                                        <thead>
                                            <tr>
                                                <th>Player</th>
                                                <th>Games</th>
                                                <th>Score</th>
                                                <th>Avg</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${roster.map(player => {
                                                const avgScore = player.games > 0 ? (player.score / player.games) : 0;
                                                const isZeroScore = player.score === 0;
                                                
                                                // Calculate gradient color based on average score (0 to 2)
                                                // 0 = grey, 0-1 = yellow shades, 1-2 = green shades
                                                let bgColor = '#9ca3af'; // Default grey for zero
                                                if (!isZeroScore) {
                                                    if (avgScore <= 1.0) {
                                                        // Yellow to light green (0 to 1)
                                                        const intensity = avgScore; // 0 to 1
                                                        const r = Math.round(236 - (intensity * 164)); // 236 to 72
                                                        const g = Math.round(201 - (intensity * 14)); // 201 to 187
                                                        const b = Math.round(75 + (intensity * 45)); // 75 to 120
                                                        bgColor = `rgb(${r}, ${g}, ${b})`;
                                                    } else {
                                                        // Light green to bright green (1 to 2)
                                                        const intensity = (avgScore - 1.0); // 0 to 1
                                                        const r = Math.round(72 - (intensity * 6)); // 72 to 66
                                                        const g = Math.round(187 + (intensity * 10)); // 187 to 197
                                                        const b = Math.round(120 - (intensity * 26)); // 120 to 94
                                                        bgColor = `rgb(${r}, ${g}, ${b})`;
                                                    }
                                                }
                                                
                                                const textColor = isZeroScore ? '#6b7280' : (avgScore > 0.75 ? 'white' : '#2d3748');
                                                const fontStyle = isZeroScore ? 'opacity: 0.5;' : '';
                                                
                                                return `
                                                    <tr style="${fontStyle}">
                                                        <td class="player-name" style="font-size: 11px;">${player.name}</td>
                                                        <td style="text-align: center;">${player.games}</td>
                                                        <td style="text-align: center;">
                                                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: ${bgColor}; color: ${textColor};">
                                                                ${player.score.toFixed(2)}
                                                            </span>
                                                        </td>
                                                        <td style="text-align: center;">
                                                            <span style="font-size: 11px; color: ${isZeroScore ? '#9ca3af' : '#4b5563'}; font-weight: 600;">
                                                                ${avgScore.toFixed(2)}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Game-by-Game View -->
                                <div>
                                    <h4 style="margin: 0 0 15px 0; color: #2d3748; font-size: 15px;">üìÖ Game-by-Game Results</h4>
                                    <div style="overflow-y: auto; max-height: 600px;">
                                        ${(() => {
                                            // Build player frequency map (how many games each player started)
                                            const playerFrequency = {};
                                            team.games.forEach(g => {
                                                (g.starters || []).forEach(player => {
                                                    if (player && player !== '') {
                                                        playerFrequency[player] = (playerFrequency[player] || 0) + 1;
                                                    }
                                                });
                                            });
                                            
                                            // Create master column assignments based on frequency
                                            // Most frequent player goes to column 0, next to column 1, etc.
                                            const playersByFrequency = Object.entries(playerFrequency)
                                                .sort((a, b) => b[1] - a[1])
                                                .map(([player, count]) => player);
                                            
                                            const totalStarters = playersByFrequency.length;
                                            
                                            // Create a map: player name -> column index
                                            const playerColumnMap = {};
                                            playersByFrequency.forEach((player, index) => {
                                                playerColumnMap[player] = index;
                                            });
                                            
                                            // Build table with dynamic columns
                                            let tableHTML = `
                                                <table class="data-table" style="margin-bottom: 0; font-size: 11px;">
                                                    <thead style="position: sticky; top: 0; background: white; z-index: 1;">
                                                        <tr>
                                                            <th>Date</th>
                                                            <th>Opponent</th>
                                                            ${playersByFrequency.map((player, idx) => 
                                                                `<th style="min-width: 100px;">Starter ${idx + 1}<br/><span style="font-size: 9px; font-weight: normal; color: #718096;">(${playerFrequency[player]} games)</span></th>`
                                                            ).join('')}
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                            `;
                                            
                                            // Sort games by date and render rows
                                            const sortedGames = team.games.sort((a, b) => {
                                                const dateA = new Date(a.date);
                                                const dateB = new Date(b.date);
                                                return dateB - dateA;
                                            });
                                            
                                            sortedGames.forEach((game, gameIdx) => {
                                                const opponent = game.isHome ? game.visitor_team : game.home_team;
                                                const homeAway = game.isHome ? 'vs' : '@';
                                                const highlights = game.highlights || {};
                                                const gameKey = game.game_key || '';
                                                
                                                const getHighlight = (playerName) => {
                                                    const playerHighlights = highlights[playerName];
                                                    const primaryHighlight = getPrimaryHighlight(playerHighlights);
                                                    
                                                    if (primaryHighlight === 'first_shot_made') return 'highlight-first-shot-made';
                                                    if (primaryHighlight === 'first_shot_missed') return 'highlight-first-shot-missed';
                                                    if (primaryHighlight === 'first_fg_made') return 'highlight-first-fg-made';
                                                    if (primaryHighlight === 'missed_shot') return 'highlight-missed-shot';
                                                    if (primaryHighlight === 'free_throw') return 'highlight-free-throw';
                                                    // Legacy support
                                                    if (primaryHighlight === 'green') return 'highlight-green';
                                                    if (primaryHighlight === 'yellow') return 'highlight-yellow';
                                                    return '';
                                                };
                                                
                                                const generateTooltipHtml = (playerName) => {
                                                    if (!playerName || playerName === '') return '';
                                                    const stats = playerScoresData[playerName];
                                                    if (!stats) return '';
                                                    
                                                    return `<div class="player-tooltip">
                                                        <div style="font-weight: 700; margin-bottom: 8px; font-size: 13px; border-bottom: 2px solid rgba(255,255,255,0.2); padding-bottom: 5px;">${playerName}</div>
                                                        <div class="tooltip-row">
                                                            <span class="tooltip-label">Games Started:</span>
                                                            <span class="tooltip-value">${stats.games_started || 0}</span>
                                                        </div>
                                                        <div class="tooltip-row">
                                                            <span class="tooltip-label">Took & Made First Shot:</span>
                                                            <span class="tooltip-value">${stats.first_shot_made || 0}</span>
                                                        </div>
                                                        <div class="tooltip-row">
                                                            <span class="tooltip-label">Took & Missed First Shot:</span>
                                                            <span class="tooltip-value">${stats.first_shot_missed || 0}</span>
                                                        </div>
                                                        <div class="tooltip-row">
                                                            <span class="tooltip-label">Made First FG (wasn't first shot):</span>
                                                            <span class="tooltip-value">${stats.first_fg_made || 0}</span>
                                                        </div>
                                                        <div class="tooltip-row">
                                                            <span class="tooltip-label">Missed Shot Before First FG:</span>
                                                            <span class="tooltip-value">${stats.missed_shot || 0}</span>
                                                        </div>
                                                        <div class="tooltip-row">
                                                            <span class="tooltip-label">Took FTs:</span>
                                                            <span class="tooltip-value">${stats.free_throw || 0}</span>
                                                        </div>
                                                        <div style="margin-top: 8px; padding-top: 8px; border-top: 2px solid rgba(255,255,255,0.2); font-weight: 700;">
                                                            <div class="tooltip-row">
                                                                <span class="tooltip-label">Total Score:</span>
                                                                <span class="tooltip-value" style="color: #fbbf24;">${stats.shot_score.toFixed(2)}</span>
                                                            </div>
                                                        </div>
                                                    </div>`;
                                                };
                                                
                                                // Place each player in their assigned column
                                                const displayStarters = new Array(totalStarters).fill('');
                                                (game.starters || []).forEach(player => {
                                                    if (player && player !== '') {
                                                        const columnIndex = playerColumnMap[player];
                                                        if (columnIndex !== undefined) {
                                                            displayStarters[columnIndex] = player;
                                                        }
                                                    }
                                                });
                                                
                                                // Game row with expand functionality
                                                tableHTML += `
                                                    <tr class="game-row" id="team-game-${teamCode}-${gameIdx}" onclick="toggleTeamGamePBP('${gameKey}', '${teamCode}', ${gameIdx})" style="cursor: pointer;">
                                                        <td style="white-space: nowrap;"><span class="expand-icon">‚ñ∂</span> ${game.date}</td>
                                                        <td style="white-space: nowrap;">${homeAway} ${opponent}</td>
                                                        ${displayStarters.map(player => 
                                                            `<td class="player-name ${getHighlight(player || '')}">${player || ''}${generateTooltipHtml(player)}</td>`
                                                        ).join('')}
                                                    </tr>
                                                    <tr class="pbp-detail-row" id="team-pbp-detail-${teamCode}-${gameIdx}">
                                                        <td colspan="${totalStarters + 2}" class="pbp-detail-cell">
                                                            <div class="pbp-detail-content" id="team-pbp-content-${teamCode}-${gameIdx}">
                                                            </div>
                                                        </td>
                                                    </tr>
                                                `;
                                            });
                                            
                                            tableHTML += `
                                                    </tbody>
                                                </table>
                                            `;
                                            
                                            return tableHTML;
                                        })()}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            analysisContent.innerHTML = html;
        }
        
        function renderAnalysisTableByPlayer(analysis) {
            const analysisContent = document.getElementById('analysisContent');
            
            // Get teams to filter by (if a game is selected)
            let filterTeams = null;
            if (selectedGameKey) {
                // Extract teams from the selected game key (format: VIS@HOM_DATE)
                const matchupPart = selectedGameKey.split('_')[0]; // e.g., "OKC@DAL"
                if (matchupPart) {
                    const teams = matchupPart.split('@'); // ["OKC", "DAL"]
                    if (teams.length === 2) {
                        filterTeams = new Set(teams);
                    }
                }
            }
            
            // Use playerScoresData from backend which includes game_details
            const displayPlayerData = {};
            
            Object.keys(playerScoresData).forEach(playerName => {
                const playerScore = playerScoresData[playerName];
                const playerTeam = playerScore.team || '';
                
                // If filtering by game, only include players whose team is one of the selected teams
                if (filterTeams && !filterTeams.has(playerTeam)) {
                    return; // Skip this player
                }
                
                // Filter game details if needed (for historical games display)
                const filteredGameDetails = filterTeams 
                    ? (playerScore.game_details || []).filter(gameDetail => {
                        // Extract teams from matchup
                        const matchup = gameDetail.matchup || '';
                        const teams = matchup.split('@');
                        return teams.some(t => filterTeams.has(t));
                    })
                    : (playerScore.game_details || []);
                
                // Only include players who have games after filtering
                if (filteredGameDetails.length > 0) {
                    // Recalculate totals based on filtered games
                    let totalScore = 0;
                    let first_shot_made = 0;
                    let first_shot_missed = 0;
                    let first_fg_made = 0;
                    let missed_shot = 0;
                    let free_throw = 0;
                    
                    filteredGameDetails.forEach(gameDetail => {
                        totalScore += gameDetail.game_score || 0;
                        (gameDetail.actions || []).forEach(action => {
                            if (action.type === 'first_shot_made') first_shot_made++;
                            else if (action.type === 'first_shot_missed') first_shot_missed++;
                            else if (action.type === 'first_fg_made') first_fg_made++;
                            else if (action.type === 'missed_shot') missed_shot++;
                            else if (action.type === 'free_throw') free_throw++;
                        });
                    });
                    
                    displayPlayerData[playerName] = {
                        name: playerName,
                        team: playerTeam,  // Use player's actual team from backend
                        games_started: filteredGameDetails.length,
                        total_score: totalScore,
                        first_shot_made,
                        first_shot_missed,
                        first_fg_made,
                        missed_shot,
                        free_throw,
                        game_details: filteredGameDetails
                    };
                }
            });
            
            // Sort players by total score (descending)
            const sortedPlayers = Object.values(displayPlayerData).sort((a, b) => {
                if (b.total_score !== a.total_score) {
                    return b.total_score - a.total_score;
                }
                return b.games_started - a.games_started;
            });
            
            const html = `
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;"></th>
                                <th>Rank</th>
                                <th>Player Name</th>
                                <th>Team</th>
                                <th>Games Started</th>
                                <th>Total Score</th>
                                <th>Avg Score</th>
                                <th title="Took & Made First Shot">First Shot Made</th>
                                <th title="Took & Missed First Shot">First Shot Missed</th>
                                <th title="Made First FG (but wasn't first shot)">First FG Made</th>
                                <th title="Missed a Shot Before First FG">Missed Shot</th>
                                <th title="Took Free Throws Before First FG">Free Throws</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedPlayers.map((player, index) => {
                                const avgScore = player.games_started > 0 ? (player.total_score / player.games_started) : 0;
                                const isZeroScore = player.total_score === 0;
                                
                                // Calculate gradient color based on average score (0 to 2)
                                let bgColor = '#9ca3af'; // Default grey for zero
                                if (!isZeroScore) {
                                    if (avgScore <= 1.0) {
                                        // Yellow to light green (0 to 1)
                                        const intensity = avgScore; // 0 to 1
                                        const r = Math.round(236 - (intensity * 164)); // 236 to 72
                                        const g = Math.round(201 - (intensity * 14)); // 201 to 187
                                        const b = Math.round(75 + (intensity * 45)); // 75 to 120
                                        bgColor = 'rgb(' + r + ', ' + g + ', ' + b + ')';
                                    } else {
                                        // Light green to bright green (1 to 2)
                                        const intensity = (avgScore - 1.0); // 0 to 1
                                        const r = Math.round(72 - (intensity * 6)); // 72 to 66
                                        const g = Math.round(187 + (intensity * 10)); // 187 to 197
                                        const b = Math.round(120 - (intensity * 26)); // 120 to 94
                                        bgColor = 'rgb(' + r + ', ' + g + ', ' + b + ')';
                                    }
                                }
                                
                                const textColor = isZeroScore ? '#6b7280' : (avgScore > 0.75 ? 'white' : '#2d3748');
                                const fontStyle = isZeroScore ? 'opacity: 0.5;' : '';
                                
                                // Game details rows
                                const gameDetailsHTML = player.game_details.map(gameDetail => {
                                    const actions = gameDetail.actions || [];
                                    const actionsHTML = actions.map(action => {
                                        const actionLabels = {
                                            'first_shot_made': 'First Shot Made',
                                            'first_shot_missed': 'First Shot Missed',
                                            'first_fg_made': 'First FG Made',
                                            'missed_shot': 'Missed Shot',
                                            'free_throw': 'Free Throw'
                                        };
                                        return '<span style="display: inline-block; margin: 2px; padding: 3px 8px; background: #e0e7ff; color: #5b21b6; border-radius: 4px; font-size: 11px;">' + (actionLabels[action.type] || action.type) + ' (+' + action.score.toFixed(2) + ')</span>';
                                    }).join('');
                                    
                                    return '<tr style="font-size: 12px; background: #f9fafb;">' +
                                        '<td style="padding: 8px; border-left: 3px solid #667eea;">' + (gameDetail.date || '') + '</td>' +
                                        '<td style="padding: 8px;">' + (gameDetail.matchup || '') + '</td>' +
                                        '<td style="padding: 8px;">' + (actionsHTML || '<span style="color: #9ca3af;">No actions</span>') + '</td>' +
                                        '<td style="padding: 8px; font-weight: 600; color: #667eea;">+' + (gameDetail.game_score || 0).toFixed(2) + '</td>' +
                                        '</tr>';
                                }).join('');
                                
                                return `
                                    <tr onclick="togglePlayerDetails('player_${index}')" style="${fontStyle} cursor: pointer;" data-player-row>
                                        <td style="text-align: center;">
                                            <span id="player_${index}_arrow" style="display: inline-block; transition: transform 0.3s; font-size: 12px;">‚ñ∂</span>
                                        </td>
                                        <td style="text-align: center; font-weight: 600; color: #667eea;">${index + 1}</td>
                                        <td class="player-name" style="font-weight: 600;">${player.name}</td>
                                        <td style="text-align: center; font-weight: 600; color: #764ba2;">${player.team || ''}</td>
                                        <td style="text-align: center;">${player.games_started}</td>
                                        <td style="text-align: center;">
                                            <span style="padding: 4px 12px; border-radius: 4px; font-weight: 600; background: ${bgColor}; color: ${textColor}; font-size: 13px;">
                                                ${player.total_score.toFixed(2)}
                                            </span>
                                        </td>
                                        <td style="text-align: center; font-weight: 600; color: ${isZeroScore ? '#9ca3af' : '#4b5563'};">
                                            ${avgScore.toFixed(2)}
                                        </td>
                                        <td style="text-align: center;">${player.first_shot_made}</td>
                                        <td style="text-align: center;">${player.first_shot_missed}</td>
                                        <td style="text-align: center;">${player.first_fg_made}</td>
                                        <td style="text-align: center;">${player.missed_shot}</td>
                                        <td style="text-align: center;">${player.free_throw}</td>
                                    </tr>
                                    <tr id="player_${index}_details" style="display: none;">
                                        <td colspan="12" style="padding: 0; background: #f3f4f6;">
                                            <div style="padding: 15px; margin: 10px 0;">
                                                <h4 style="margin: 0 0 10px 0; color: #2d3748; font-size: 14px;">Game-by-Game Breakdown for ${player.name}</h4>
                                                <table style="width: 100%; border-collapse: collapse;">
                                                    <thead>
                                                        <tr style="background: #e5e7eb; font-size: 12px;">
                                                            <th style="padding: 8px; text-align: left;">Date</th>
                                                            <th style="padding: 8px; text-align: left;">Matchup</th>
                                                            <th style="padding: 8px; text-align: left;">Actions</th>
                                                            <th style="padding: 8px; text-align: left;">Score</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${gameDetailsHTML}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            analysisContent.innerHTML = html;
        }
        
        function togglePlayerDetails(playerId) {
            const details = document.getElementById(`${playerId}_details`);
            const arrow = document.getElementById(`${playerId}_arrow`);
            
            if (details.style.display === 'none') {
                details.style.display = 'table-row';
                arrow.style.transform = 'rotate(90deg)';
            } else {
                details.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }
        
        function toggleTeamDetails(teamId) {
            const details = document.getElementById(`${teamId}_details`);
            const arrow = document.getElementById(`${teamId}_arrow`);
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                details.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Add event delegation for tooltip positioning
        document.addEventListener('mouseover', (e) => {
            const playerCell = e.target.closest('.player-name');
            if (playerCell) {
                const tooltip = playerCell.querySelector('.player-tooltip');
                if (tooltip) {
                    playerCell.classList.add('show-tooltip');
                    
                    // Position tooltip near cursor
                    const rect = playerCell.getBoundingClientRect();
                    tooltip.style.left = (rect.left + rect.width / 2 - 110) + 'px'; // Center horizontally
                    tooltip.style.top = (rect.bottom + 5) + 'px'; // Below the cell
                }
            }
        });
        
        document.addEventListener('mouseout', (e) => {
            const playerCell = e.target.closest('.player-name');
            if (playerCell && !playerCell.contains(e.relatedTarget)) {
                playerCell.classList.remove('show-tooltip');
            }
        });
        
        window.addEventListener('load', () => {
            refreshAnalysis();
        });
    </script>
</body>
</html>


