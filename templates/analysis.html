<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>First Shot Analysis - Basketball Scraper</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2d3748;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #48bb78;
            color: white;
        }

        .btn-secondary:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .main-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .stat-item {
            flex: 1;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th {
            background: #667eea;
            color: white;
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
        }

        .data-table td {
            padding: 6px 6px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 10px;
            white-space: nowrap;
        }

        .data-table td.player-name {
            white-space: normal;
            word-wrap: break-word;
            max-width: 100px;
        }

        .data-table tbody tr.game-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .data-table tbody tr.game-row:hover {
            background-color: #edf2f7 !important;
        }

        .data-table tbody tr.game-row.expanded {
            background-color: #e6fffa !important;
        }

        .pbp-detail-row {
            display: none;
            background-color: #f7fafc;
        }

        .pbp-detail-row.show {
            display: table-row;
        }

        .pbp-detail-cell {
            padding: 0 !important;
            border: none !important;
        }

        .pbp-detail-content {
            padding: 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .pbp-detail-content.expanded {
            max-height: 1000px;
            transition: max-height 0.5s ease-in;
        }

        .pbp-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .pbp-table th {
            background: #48bb78;
            color: white;
            padding: 10px;
            text-align: left;
            font-size: 12px;
        }

        .pbp-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 11px;
        }

        .pbp-table tr:last-child td {
            border-bottom: none;
        }

        .pbp-table tr:hover {
            background-color: #f7fafc;
        }

        .pbp-loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .expand-icon {
            display: inline-block;
            margin-right: 8px;
            transition: transform 0.3s ease;
            font-size: 14px;
        }

        .game-row.expanded .expand-icon {
            transform: rotate(90deg);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        /* First shot made (took and made the very first shot) - bright green border */
        .highlight-first-shot-made {
            background-color: #48bb78 !important;
            color: white !important;
            font-weight: 600;
            border: 3px solid #22c55e !important;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.6) !important;
        }
        
        /* First shot missed (took and missed the very first shot) - bright yellow border */
        .highlight-first-shot-missed {
            background-color: #ecc94b !important;
            color: #2d3748 !important;
            font-weight: 600;
            border: 3px solid #facc15 !important;
            box-shadow: 0 0 8px rgba(250, 204, 21, 0.6) !important;
        }
        
        /* First FG made (but not the first shot) - regular green fill */
        .highlight-first-fg-made {
            background-color: #48bb78 !important;
            color: white !important;
            font-weight: 600;
        }
        
        /* Missed shot (but not the first shot) - regular yellow fill */
        .highlight-missed-shot {
            background-color: #ecc94b !important;
            color: #2d3748 !important;
            font-weight: 600;
        }
        
        /* Free throw - yellow outline only */
        .highlight-free-throw {
            border: 2px solid #ecc94b !important;
            color: #2d3748 !important;
            font-weight: 600;
        }
        
        /* Legacy classes for backwards compatibility */
        .highlight-green {
            background-color: #48bb78 !important;
            color: white !important;
            font-weight: 600;
        }

        .highlight-yellow {
            background-color: #ecc94b !important;
            color: #2d3748 !important;
            font-weight: 600;
        }

        .legend {
            margin-top: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 0.8s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with Navigation -->
        <div class="header">
            <h1>üéØ First Shot Analysis</h1>
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="refreshAnalysis()">
                    üîÑ Refresh Analysis
                </button>
                <a href="/" class="btn btn-primary">
                    ‚¨ÖÔ∏è Back to Scraper
                </a>
            </div>
        </div>

        <!-- Upcoming Games -->
        <div class="main-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #2d3748; margin: 0;">üîÆ Upcoming Games with Player Scores</h2>
                <div id="filterIndicator" style="display: none;">
                    <button onclick="filterByGameKey(null)" 
                            onmouseover="this.style.background='#f56565'" 
                            onmouseout="this.style.background='#fc8181'"
                            style="padding: 8px 16px; background: #fc8181; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition: background 0.2s;">
                        ‚úï Clear Filter
                    </button>
                </div>
            </div>
            <div id="upcomingGamesContent">
                <div class="empty-state">
                    <div class="empty-state-icon">üìÖ</div>
                    <h3>No Upcoming Games</h3>
                    <p>Run Phase 4 to fetch today and tomorrow's games.</p>
                </div>
            </div>
        </div>

        <div class="main-card">
            <h3 style="margin-bottom: 15px; color: #2d3748;">Player Score Legend</h3>
            <div style="background: #f7fafc; padding: 15px; border-radius: 8px; font-size: 13px;">
                <p><strong>Shot Score:</strong> Calculated as (Made First FG √ó 1.0) + (Missed/FT Before First FG √ó 0.5)</p>
                <p style="margin-top: 10px;"><strong>Games Started:</strong> Total number of games the player has started</p>
                <p style="margin-top: 10px;"><strong>Format:</strong> Shot Score / Games Started</p>
            </div>
        </div>

        <!-- Historical Analysis Table -->
        <div class="main-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #2d3748;">üìä Historical Game Analysis</h2>
                <div style="display: flex; gap: 10px;">
                    <button id="viewByGameBtn" onclick="switchHistoricalView('game')" 
                            style="padding: 8px 16px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        By Game
                    </button>
                    <button id="viewByTeamBtn" onclick="switchHistoricalView('team')" 
                            style="padding: 8px 16px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        By Team
                    </button>
                </div>
            </div>
            <div class="legend" style="margin-bottom: 20px;">
                <strong>Legend:</strong>
                <div class="legend-item">
                    <span class="legend-color highlight-first-shot-made" style="padding: 4px 8px;">Bright Green</span>
                    <span>Took & made the FIRST shot of the game (+2.0)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color highlight-first-shot-missed" style="padding: 4px 8px;">Bright Yellow</span>
                    <span>Took & missed the FIRST shot of the game (+1.0)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color highlight-first-fg-made" style="padding: 4px 8px;">Green</span>
                    <span>Made first FG (but wasn't first shot) (+0.75)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color highlight-missed-shot" style="padding: 4px 8px;">Yellow</span>
                    <span>Missed shot before first FG (+0.5)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color highlight-free-throw" style="padding: 4px 8px;">Outline</span>
                    <span>Took free throws before first FG (+0.25)</span>
                </div>
            </div>
            <div id="analysisContent">
                <div class="empty-state">
                    <div class="empty-state-icon">üèÄ</div>
                    <h3>No Analysis Data Available</h3>
                    <p>Click "Refresh Analysis" to load data from CSV files, or run the scraper first.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let analysisData = [];
        let pbpDataCache = null;
        let currentHistoricalView = 'game'; // 'game' or 'team'
        let selectedGameKey = null; // For filtering by game
        let upcomingGamesData = []; // Store upcoming games data
        let playerScoresData = {}; // Store player scores data

        async function loadPBPData() {
            if (pbpDataCache) return pbpDataCache;
            
            try {
                const response = await fetch('/api/preview?from_csv=true');
                const data = await response.json();
                pbpDataCache = data.pbp_preview || [];
                return pbpDataCache;
            } catch (error) {
                console.error('Error loading PBP data:', error);
                return [];
            }
        }

        async function toggleGamePBP(gameKey, rowIndex) {
            const gameRow = document.querySelector(`tr[data-game-key="${gameKey}"]`);
            const detailRow = document.getElementById(`pbp-detail-${rowIndex}`);
            const detailContent = document.getElementById(`pbp-content-${rowIndex}`);
            
            // Toggle expanded state
            const isExpanded = gameRow.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse
                gameRow.classList.remove('expanded');
                detailContent.classList.remove('expanded');
                setTimeout(() => {
                    detailRow.classList.remove('show');
                }, 300);
            } else {
                // Expand
                gameRow.classList.add('expanded');
                detailRow.classList.add('show');
                
                // Load PBP data if not already loaded
                if (!detailContent.dataset.loaded) {
                    detailContent.innerHTML = '<div class="pbp-loading"><div class="spinner"></div> Loading play-by-play data...</div>';
                    
                    setTimeout(async () => {
                        const allPBP = await loadPBPData();
                        const gamePBP = allPBP.filter(play => play.game_key === gameKey);
                        
                        if (gamePBP.length > 0) {
                            const pbpHTML = `
                                <h3 style="margin-bottom: 15px; color: #2d3748;">Play-by-Play: ${gameKey}</h3>
                                <table class="pbp-table">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Visitor Play</th>
                                            <th>Home Play</th>
                                            <th>Score</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${gamePBP.map(play => `
                                            <tr>
                                                <td>${play.time || ''}</td>
                                                <td>${play.visitor_play || ''}</td>
                                                <td>${play.home_play || ''}</td>
                                                <td>${play.score || ''}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            `;
                            detailContent.innerHTML = pbpHTML;
                        } else {
                            detailContent.innerHTML = '<div class="pbp-loading">No play-by-play data available for this game.</div>';
                        }
                        
                        detailContent.dataset.loaded = 'true';
                        detailContent.classList.add('expanded');
                    }, 50);
                } else {
                    // Already loaded, just expand
                    setTimeout(() => {
                        detailContent.classList.add('expanded');
                    }, 50);
                }
            }
        }

        async function refreshAnalysis() {
            const analysisContent = document.getElementById('analysisContent');
            const upcomingContent = document.getElementById('upcomingGamesContent');
            
            analysisContent.innerHTML = '<div class="loading"><div class="spinner"></div> Loading analysis...</div>';
            upcomingContent.innerHTML = '<div class="loading"><div class="spinner"></div> Loading upcoming games...</div>';

            try {
                const response = await fetch('/api/analysis?from_csv=true');
                const data = await response.json();

                if (data.error) {
                    analysisContent.innerHTML = `
                        <div class="error-message">
                            <strong>Error:</strong> ${data.error}
                        </div>
                        <div class="empty-state">
                            <div class="empty-state-icon">‚ö†Ô∏è</div>
                            <h3>Could not load analysis</h3>
                            <p>Make sure you have run the scraper and CSV files exist.</p>
                        </div>
                    `;
                    upcomingContent.innerHTML = '<div class="empty-state">No upcoming games available.</div>';
                    return;
                }

                // Render upcoming games with player scores
                if (data.upcoming_games && data.upcoming_games.length > 0) {
                    renderUpcomingGames(data.upcoming_games, data.player_scores || {});
                } else {
                    upcomingContent.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <h3>No Upcoming Games</h3>
                            <p>Run Phase 4 to fetch today and tomorrow's games.</p>
                        </div>
                    `;
                }

                // Render historical analysis table
                if (data.analysis && data.analysis.length > 0) {
                    renderAnalysisTable(data.analysis);
                } else {
                    analysisContent.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <h3>No Historical Data</h3>
                            <p>Run Phases 1-3 to collect game data first.</p>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Error loading analysis:', error);
                analysisContent.innerHTML = `
                    <div class="error-message">
                        <strong>Error:</strong> ${error.message}
                    </div>
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <h3>Failed to Load Analysis</h3>
                        <p>Please try again or check the console for details.</p>
                    </div>
                `;
                upcomingContent.innerHTML = '<div class="empty-state">Error loading upcoming games.</div>';
            }
        }

        function filterByGameKey(gameKey) {
            if (selectedGameKey === gameKey || gameKey === null) {
                // Toggle off - remove filter
                selectedGameKey = null;
            } else {
                // Apply filter
                selectedGameKey = gameKey;
            }
            
            // Show/hide filter indicator
            const filterIndicator = document.getElementById('filterIndicator');
            if (selectedGameKey) {
                filterIndicator.style.display = 'block';
            } else {
                filterIndicator.style.display = 'none';
            }
            
            // Re-render both tables with the filter
            renderUpcomingGames(upcomingGamesData, playerScoresData);
            
            if (currentHistoricalView === 'team') {
                renderAnalysisTableByTeam(analysisData);
            } else {
                renderAnalysisTable(analysisData);
            }
        }

        function renderUpcomingGames(upcomingGames, playerScores) {
            upcomingGamesData = upcomingGames;
            playerScoresData = playerScores;
            
            const upcomingContent = document.getElementById('upcomingGamesContent');
            
            const getPlayerScoreDisplay = (playerName) => {
                if (!playerName || playerName === '') return '';
                const score = playerScores[playerName];
                if (score) {
                    return `${score.shot_score.toFixed(1)}/${score.games_started}`;
                }
                return '0.0/0';
            };
            
            const getScoreStyle = (playerName) => {
                if (!playerName || playerName === '') return '';
                const score = playerScores[playerName];
                if (score && score.shot_score > 0) {
                    const ratio = score.shot_score / score.games_started;
                    if (ratio >= 0.7) return 'background: #48bb78; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 600;';
                    if (ratio >= 0.4) return 'background: #ecc94b; color: #2d3748; padding: 2px 6px; border-radius: 4px; font-weight: 600;';
                }
                return '';
            };
            
            // Filter games if a game key is selected
            const displayGames = selectedGameKey 
                ? upcomingGames.filter(g => g.game_key === selectedGameKey)
                : upcomingGames;
            
            // Group games by date
            const gamesByDate = {};
            displayGames.forEach(game => {
                const date = game.date || 'Unknown Date';
                if (!gamesByDate[date]) {
                    gamesByDate[date] = [];
                }
                gamesByDate[date].push(game);
            });
            
            // Sort dates (today first, then tomorrow)
            const sortedDates = Object.keys(gamesByDate).sort();
            
            // Render games grouped by date with collapsible sections
            const html = sortedDates.map(date => {
                const games = gamesByDate[date];
                const dateId = date.replace(/\//g, '-');
                
                return `
                    <div style="margin-bottom: 15px;">
                        <div style="background: #667eea; color: white; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; justify-content: space-between; align-items: center;" 
                             onclick="toggleDateSection('${dateId}')">
                            <span><span id="icon-${dateId}" style="font-size: 14px; margin-right: 8px;">‚ñº</span>${date} (${games.length} game${games.length !== 1 ? 's' : ''})</span>
                        </div>
                        <div id="date-${dateId}" style="margin-top: 10px;">
                            <div style="overflow-x: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th title="Click on a game key to filter data">Game Key üîç</th>
                                            <th>Matchup</th>
                                            <th>V Starter 1</th>
                                            <th>V Starter 2</th>
                                            <th>V Starter 3</th>
                                            <th>V Starter 4</th>
                                            <th>V Starter 5</th>
                                            <th>H Starter 1</th>
                                            <th>H Starter 2</th>
                                            <th>H Starter 3</th>
                                            <th>H Starter 4</th>
                                            <th>H Starter 5</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${games.map(game => {
                                            const isSelected = selectedGameKey === game.game_key;
                                            const gameKeyStyle = isSelected 
                                                ? 'cursor: pointer; color: #667eea; font-weight: 700; text-decoration: underline; background: #eef2ff;'
                                                : 'cursor: pointer; color: #667eea; font-weight: 600; text-decoration: underline;';
                                            
                                            return `
                                                <tr>
                                                    <td style="${gameKeyStyle}" onclick="filterByGameKey('${game.game_key || ''}')" title="Click to filter">${game.game_key || ''}</td>
                                                    <td>${game.matchup || ''}</td>
                                                    <td class="player-name">
                                                        <div>${game.V_s1 || ''}</div>
                                                        <div style="font-size: 9px; color: #667eea; ${getScoreStyle(game.V_s1)}">${getPlayerScoreDisplay(game.V_s1)}</div>
                                                    </td>
                                                    <td class="player-name">
                                                        <div>${game.V_s2 || ''}</div>
                                                        <div style="font-size: 9px; color: #667eea; ${getScoreStyle(game.V_s2)}">${getPlayerScoreDisplay(game.V_s2)}</div>
                                                    </td>
                                                    <td class="player-name">
                                                        <div>${game.V_s3 || ''}</div>
                                                        <div style="font-size: 9px; color: #667eea; ${getScoreStyle(game.V_s3)}">${getPlayerScoreDisplay(game.V_s3)}</div>
                                                    </td>
                                                    <td class="player-name">
                                                        <div>${game.V_s4 || ''}</div>
                                                        <div style="font-size: 9px; color: #667eea; ${getScoreStyle(game.V_s4)}">${getPlayerScoreDisplay(game.V_s4)}</div>
                                                    </td>
                                                    <td class="player-name">
                                                        <div>${game.V_s5 || ''}</div>
                                                        <div style="font-size: 9px; color: #667eea; ${getScoreStyle(game.V_s5)}">${getPlayerScoreDisplay(game.V_s5)}</div>
                                                    </td>
                                                    <td class="player-name">
                                                        <div>${game.H_s1 || ''}</div>
                                                        <div style="font-size: 9px; color: #48bb78; ${getScoreStyle(game.H_s1)}">${getPlayerScoreDisplay(game.H_s1)}</div>
                                                    </td>
                                                    <td class="player-name">
                                                        <div>${game.H_s2 || ''}</div>
                                                        <div style="font-size: 9px; color: #48bb78; ${getScoreStyle(game.H_s2)}">${getPlayerScoreDisplay(game.H_s2)}</div>
                                                    </td>
                                                    <td class="player-name">
                                                        <div>${game.H_s3 || ''}</div>
                                                        <div style="font-size: 9px; color: #48bb78; ${getScoreStyle(game.H_s3)}">${getPlayerScoreDisplay(game.H_s3)}</div>
                                                    </td>
                                                    <td class="player-name">
                                                        <div>${game.H_s4 || ''}</div>
                                                        <div style="font-size: 9px; color: #48bb78; ${getScoreStyle(game.H_s4)}">${getPlayerScoreDisplay(game.H_s4)}</div>
                                                    </td>
                                                    <td class="player-name">
                                                        <div>${game.H_s5 || ''}</div>
                                                        <div style="font-size: 9px; color: #48bb78; ${getScoreStyle(game.H_s5)}">${getPlayerScoreDisplay(game.H_s5)}</div>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            upcomingContent.innerHTML = html;
        }
        
        function toggleDateSection(dateId) {
            const section = document.getElementById(`date-${dateId}`);
            const icon = document.getElementById(`icon-${dateId}`);
            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.textContent = '‚ñº';
            } else {
                section.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }

        function renderAnalysisTable(analysis) {
            analysisData = analysis;
            const analysisContent = document.getElementById('analysisContent');
            
            // Get teams to filter by (if a game is selected)
            let filterTeams = null;
            if (selectedGameKey) {
                // Extract teams from the selected game key (format: VIS@HOM_DATE)
                const matchupPart = selectedGameKey.split('_')[0]; // e.g., "OKC@DAL"
                if (matchupPart) {
                    const teams = matchupPart.split('@'); // ["OKC", "DAL"]
                    if (teams.length === 2) {
                        filterTeams = new Set(teams);
                    }
                }
            }
            
            // Filter analysis if needed
            const displayAnalysis = filterTeams 
                ? analysis.filter(game => {
                    return filterTeams.has(game.visitor_team) || filterTeams.has(game.home_team);
                })
                : analysis;

            const html = `
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Game Key</th>
                                <th>Date</th>
                                <th>Matchup</th>
                                <th>Visitor Starter 1</th>
                                <th>Visitor Starter 2</th>
                                <th>Visitor Starter 3</th>
                                <th>Visitor Starter 4</th>
                                <th>Visitor Starter 5</th>
                                <th>Home Starter 1</th>
                                <th>Home Starter 2</th>
                                <th>Home Starter 3</th>
                                <th>Home Starter 4</th>
                                <th>Home Starter 5</th>
                                <th>PBP Plays</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${displayAnalysis.map((game, index) => {
                                const highlights = game.highlights || {};
                                
                                const getHighlight = (playerName) => {
                                    const highlightType = highlights[playerName];
                                    if (highlightType === 'first_shot_made') return 'highlight-first-shot-made';
                                    if (highlightType === 'first_shot_missed') return 'highlight-first-shot-missed';
                                    if (highlightType === 'first_fg_made') return 'highlight-first-fg-made';
                                    if (highlightType === 'missed_shot') return 'highlight-missed-shot';
                                    if (highlightType === 'free_throw') return 'highlight-free-throw';
                                    // Legacy support
                                    if (highlightType === 'green') return 'highlight-green';
                                    if (highlightType === 'yellow') return 'highlight-yellow';
                                    return '';
                                };
                                
                                const vStarters = game.visitor_starters || [];
                                const hStarters = game.home_starters || [];
                                const gameKey = game.game_key || '';
                                
                                return `
                                    <tr class="game-row" data-game-key="${gameKey}" onclick="toggleGamePBP('${gameKey}', ${index})">
                                        <td><span class="expand-icon">‚ñ∂</span>${gameKey}</td>
                                        <td>${game.date || ''}</td>
                                        <td>${game.matchup || ''}</td>
                                        <td class="player-name ${getHighlight(vStarters[0])}">${vStarters[0] || ''}</td>
                                        <td class="player-name ${getHighlight(vStarters[1])}">${vStarters[1] || ''}</td>
                                        <td class="player-name ${getHighlight(vStarters[2])}">${vStarters[2] || ''}</td>
                                        <td class="player-name ${getHighlight(vStarters[3])}">${vStarters[3] || ''}</td>
                                        <td class="player-name ${getHighlight(vStarters[4])}">${vStarters[4] || ''}</td>
                                        <td class="player-name ${getHighlight(hStarters[0])}">${hStarters[0] || ''}</td>
                                        <td class="player-name ${getHighlight(hStarters[1])}">${hStarters[1] || ''}</td>
                                        <td class="player-name ${getHighlight(hStarters[2])}">${hStarters[2] || ''}</td>
                                        <td class="player-name ${getHighlight(hStarters[3])}">${hStarters[3] || ''}</td>
                                        <td class="player-name ${getHighlight(hStarters[4])}">${hStarters[4] || ''}</td>
                                        <td>${game.pbp_count || 0}</td>
                                    </tr>
                                    <tr class="pbp-detail-row" id="pbp-detail-${index}">
                                        <td colspan="14" class="pbp-detail-cell">
                                            <div class="pbp-detail-content" id="pbp-content-${index}">
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            analysisContent.innerHTML = html;
        }

        // Auto-load on page load
        function switchHistoricalView(viewType) {
            currentHistoricalView = viewType;
            
            // Update button styles
            const gameBtn = document.getElementById('viewByGameBtn');
            const teamBtn = document.getElementById('viewByTeamBtn');
            
            if (viewType === 'game') {
                gameBtn.style.background = '#667eea';
                gameBtn.style.color = 'white';
                teamBtn.style.background = 'white';
                teamBtn.style.color = '#667eea';
                renderAnalysisTable(analysisData);
            } else {
                gameBtn.style.background = 'white';
                gameBtn.style.color = '#667eea';
                teamBtn.style.background = '#667eea';
                teamBtn.style.color = 'white';
                renderAnalysisTableByTeam(analysisData);
            }
        }

        function renderAnalysisTableByTeam(analysis) {
            const analysisContent = document.getElementById('analysisContent');
            
            // Get teams to filter by (if a game is selected)
            let filterTeams = null;
            if (selectedGameKey) {
                // Extract teams from the selected game key (format: VIS@HOM_DATE)
                const matchupPart = selectedGameKey.split('_')[0]; // e.g., "OKC@DAL"
                if (matchupPart) {
                    const teams = matchupPart.split('@'); // ["OKC", "DAL"]
                    if (teams.length === 2) {
                        filterTeams = new Set(teams);
                    }
                }
            }
            
            // Group games by team
            const teamData = {};
            
            analysis.forEach(game => {
                const visitorTeam = game.visitor_team;
                const homeTeam = game.home_team;
                
                // Process visitor team
                if (visitorTeam && (!filterTeams || filterTeams.has(visitorTeam))) {
                    if (!teamData[visitorTeam]) {
                        teamData[visitorTeam] = {
                            teamCode: visitorTeam,
                            games: []
                        };
                    }
                    teamData[visitorTeam].games.push({
                        ...game,
                        starters: game.visitor_starters || [],
                        isHome: false
                    });
                }
                
                // Process home team
                if (homeTeam && (!filterTeams || filterTeams.has(homeTeam))) {
                    if (!teamData[homeTeam]) {
                        teamData[homeTeam] = {
                            teamCode: homeTeam,
                            games: []
                        };
                    }
                    teamData[homeTeam].games.push({
                        ...game,
                        starters: game.home_starters || [],
                        isHome: true
                    });
                }
            });
            
            // Sort teams alphabetically
            const sortedTeams = Object.keys(teamData).sort();
            
            let html = '<div style="overflow-x: auto;">';
            
            sortedTeams.forEach(teamCode => {
                const team = teamData[teamCode];
                const totalGames = team.games.length;
                
                                // Build roster from all games to get unique starters
                                const rosterMap = {};
                                team.games.forEach(game => {
                                    game.starters.forEach(player => {
                                        if (player && player !== '') {
                                            if (!rosterMap[player]) {
                                                rosterMap[player] = {
                                                    name: player,
                                                    games: 0,
                                                    score: 0
                                                };
                                            }
                                            rosterMap[player].games++;
                                            
                                            // Check highlights and add score
                                            const highlights = game.highlights || {};
                                            const highlightType = highlights[player];
                                            if (highlightType === 'first_shot_made') {
                                                rosterMap[player].score += 2.0;
                                            } else if (highlightType === 'first_shot_missed') {
                                                rosterMap[player].score += 1.0;
                                            } else if (highlightType === 'first_fg_made') {
                                                rosterMap[player].score += 0.75;
                                            } else if (highlightType === 'missed_shot') {
                                                rosterMap[player].score += 0.5;
                                            } else if (highlightType === 'free_throw') {
                                                rosterMap[player].score += 0.25;
                                            }
                                            // Legacy support
                                            else if (highlightType === 'green') {
                                                rosterMap[player].score += 0.75;
                                            } else if (highlightType === 'yellow') {
                                                rosterMap[player].score += 0.5;
                                            }
                                        }
                                    });
                                });
                                
                                const roster = Object.values(rosterMap).sort((a, b) => b.score - a.score || b.games - a.games);
                
                html += `
                    <div style="margin-bottom: 30px; border: 2px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                             onclick="toggleTeamDetails('team_${teamCode}')">
                            <div>
                                <h3 style="margin: 0; font-size: 18px;">üèÄ ${teamCode}</h3>
                                <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.9;">${totalGames} games ‚Ä¢ ${roster.length} players</p>
                            </div>
                            <span id="team_${teamCode}_arrow" style="font-size: 24px; transition: transform 0.3s;">‚ñº</span>
                        </div>
                        
                        <div id="team_${teamCode}_details" style="display: none; padding: 20px; background: #f7fafc;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <!-- Aggregated Player Stats -->
                                <div>
                                    <h4 style="margin: 0 0 15px 0; color: #2d3748; font-size: 15px;">üìä Aggregated Player Stats</h4>
                                    <table class="data-table" style="margin-bottom: 0; font-size: 12px;">
                                        <thead>
                                            <tr>
                                                <th>Player</th>
                                                <th>Games</th>
                                                <th>Score</th>
                                                <th>Avg</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${roster.map(player => {
                                                const avgScore = player.games > 0 ? (player.score / player.games) : 0;
                                                const isZeroScore = player.score === 0;
                                                
                                                // Calculate gradient color based on average score (0 to 2)
                                                // 0 = grey, 0-1 = yellow shades, 1-2 = green shades
                                                let bgColor = '#9ca3af'; // Default grey for zero
                                                if (!isZeroScore) {
                                                    if (avgScore <= 1.0) {
                                                        // Yellow to light green (0 to 1)
                                                        const intensity = avgScore; // 0 to 1
                                                        const r = Math.round(236 - (intensity * 164)); // 236 to 72
                                                        const g = Math.round(201 - (intensity * 14)); // 201 to 187
                                                        const b = Math.round(75 + (intensity * 45)); // 75 to 120
                                                        bgColor = `rgb(${r}, ${g}, ${b})`;
                                                    } else {
                                                        // Light green to bright green (1 to 2)
                                                        const intensity = (avgScore - 1.0); // 0 to 1
                                                        const r = Math.round(72 - (intensity * 6)); // 72 to 66
                                                        const g = Math.round(187 + (intensity * 10)); // 187 to 197
                                                        const b = Math.round(120 - (intensity * 26)); // 120 to 94
                                                        bgColor = `rgb(${r}, ${g}, ${b})`;
                                                    }
                                                }
                                                
                                                const textColor = isZeroScore ? '#6b7280' : (avgScore > 0.75 ? 'white' : '#2d3748');
                                                const fontStyle = isZeroScore ? 'opacity: 0.5;' : '';
                                                
                                                return `
                                                    <tr style="${fontStyle}">
                                                        <td class="player-name" style="font-size: 11px;">${player.name}</td>
                                                        <td style="text-align: center;">${player.games}</td>
                                                        <td style="text-align: center;">
                                                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: ${bgColor}; color: ${textColor};">
                                                                ${player.score.toFixed(2)}
                                                            </span>
                                                        </td>
                                                        <td style="text-align: center;">
                                                            <span style="font-size: 11px; color: ${isZeroScore ? '#9ca3af' : '#4b5563'}; font-weight: 600;">
                                                                ${avgScore.toFixed(2)}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Game-by-Game View -->
                                <div>
                                    <h4 style="margin: 0 0 15px 0; color: #2d3748; font-size: 15px;">üìÖ Game-by-Game Results</h4>
                                    <div style="overflow-y: auto; max-height: 600px;">
                                        ${(() => {
                                            // Build player frequency map (how many games each player started)
                                            const playerFrequency = {};
                                            team.games.forEach(g => {
                                                (g.starters || []).forEach(player => {
                                                    if (player && player !== '') {
                                                        playerFrequency[player] = (playerFrequency[player] || 0) + 1;
                                                    }
                                                });
                                            });
                                            
                                            // Create master column assignments based on frequency
                                            // Most frequent player goes to column 0, next to column 1, etc.
                                            const playersByFrequency = Object.entries(playerFrequency)
                                                .sort((a, b) => b[1] - a[1])
                                                .map(([player, count]) => player);
                                            
                                            const totalStarters = playersByFrequency.length;
                                            
                                            // Create a map: player name -> column index
                                            const playerColumnMap = {};
                                            playersByFrequency.forEach((player, index) => {
                                                playerColumnMap[player] = index;
                                            });
                                            
                                            // Build table with dynamic columns
                                            let tableHTML = `
                                                <table class="data-table" style="margin-bottom: 0; font-size: 11px;">
                                                    <thead style="position: sticky; top: 0; background: white; z-index: 1;">
                                                        <tr>
                                                            <th>Date</th>
                                                            <th>Opponent</th>
                                                            ${playersByFrequency.map((player, idx) => 
                                                                `<th style="min-width: 100px;">Starter ${idx + 1}<br/><span style="font-size: 9px; font-weight: normal; color: #718096;">(${playerFrequency[player]} games)</span></th>`
                                                            ).join('')}
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                            `;
                                            
                                            // Sort games by date and render rows
                                            const sortedGames = team.games.sort((a, b) => {
                                                const dateA = new Date(a.date);
                                                const dateB = new Date(b.date);
                                                return dateB - dateA;
                                            });
                                            
                                            sortedGames.forEach(game => {
                                                const opponent = game.isHome ? game.visitor_team : game.home_team;
                                                const homeAway = game.isHome ? 'vs' : '@';
                                                const highlights = game.highlights || {};
                                                
                                                const getHighlight = (playerName) => {
                                                    const highlightType = highlights[playerName];
                                                    if (highlightType === 'first_shot_made') return 'highlight-first-shot-made';
                                                    if (highlightType === 'first_shot_missed') return 'highlight-first-shot-missed';
                                                    if (highlightType === 'first_fg_made') return 'highlight-first-fg-made';
                                                    if (highlightType === 'missed_shot') return 'highlight-missed-shot';
                                                    if (highlightType === 'free_throw') return 'highlight-free-throw';
                                                    // Legacy support
                                                    if (highlightType === 'green') return 'highlight-green';
                                                    if (highlightType === 'yellow') return 'highlight-yellow';
                                                    return '';
                                                };
                                                
                                                // Place each player in their assigned column
                                                const displayStarters = new Array(totalStarters).fill('');
                                                (game.starters || []).forEach(player => {
                                                    if (player && player !== '') {
                                                        const columnIndex = playerColumnMap[player];
                                                        if (columnIndex !== undefined) {
                                                            displayStarters[columnIndex] = player;
                                                        }
                                                    }
                                                });
                                                
                                                tableHTML += `
                                                    <tr>
                                                        <td style="white-space: nowrap;">${game.date}</td>
                                                        <td style="white-space: nowrap;">${homeAway} ${opponent}</td>
                                                        ${displayStarters.map(player => 
                                                            `<td class="player-name ${getHighlight(player || '')}">${player || ''}</td>`
                                                        ).join('')}
                                                    </tr>
                                                `;
                                            });
                                            
                                            tableHTML += `
                                                    </tbody>
                                                </table>
                                            `;
                                            
                                            return tableHTML;
                                        })()}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            analysisContent.innerHTML = html;
        }
        
        function toggleTeamDetails(teamId) {
            const details = document.getElementById(`${teamId}_details`);
            const arrow = document.getElementById(`${teamId}_arrow`);
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                details.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        window.addEventListener('load', () => {
            refreshAnalysis();
        });
    </script>
</body>
</html>


